<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù„Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #0a0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #1a0505 0%, #000 100%); touch-action: manipulation;}
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-info-bar { padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.8); border-bottom: 2px solid #451a03; height: 70px; z-index: 20; box-shadow: 0 5px 20px rgba(0,0,0,0.8);}
        .target-display { display: flex; align-items: center; gap: 10px; background: #2a0a0a; padding: 5px 15px; border-radius: 30px; border: 1px solid #dc2626;}
        .target-icon { font-weight: bold; font-size: 1.2rem; color: #f59e0b;}
        .room-pin-top { font-family: monospace; color: #666; font-size: 1rem; letter-spacing: 1px;}

        /* Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .table-area { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; perspective: 1000px; overflow: hidden;}
        
        /* Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ */
        .table-felt { width: 300px; height: 300px; background: radial-gradient(circle, #065f46 0%, #064e3b 100%); border-radius: 50%; border: 15px solid #3f1a08; box-shadow: inset 0 0 60px rgba(0,0,0,0.9), 0 30px 80px rgba(0,0,0,0.8); position: relative; display: flex; justify-content: center; align-items: center;}
        
        .discard-pile { position: relative; width: 60px; height: 90px;}
        .thrown-card { position: absolute; width: 65px; height: 90px; background-image: url('https://deckofcardsapi.com/static/img/back.png'); background-size: cover; border-radius: 5px; box-shadow: 2px 2px 8px rgba(0,0,0,0.6); border: 1px solid #aaa; top: 0; left: 0;}

        /* Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-seat { position: absolute; width: 80px; height: 100px; display: flex; flex-direction: column; align-items: center; transition: all 0.5s; z-index: 10;}
        .avatar { width: 55px; height: 55px; background: #1f2937; border-radius: 50%; border: 3px solid #4b5563; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; transition: 0.3s;}
        .avatar span { font-size: 25px; }
        .p-name { background: rgba(0,0,0,0.9); padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; margin-top: -10px; z-index: 2; border: 1px solid #333; white-space: nowrap; max-width: 90px; overflow: hidden; text-overflow: ellipsis; color: #ddd;}
        .p-gun { font-size: 0.75rem; color: #ef4444; font-weight: bold; background: #1a0505; padding: 2px 6px; border-radius: 4px; margin-top: 3px; border: 1px solid #333;}
        
        .active-turn .avatar { border-color: #f59e0b; box-shadow: 0 0 25px rgba(245, 158, 11, 0.8); transform: scale(1.15);}
        .active-turn .p-name { color: #f59e0b; border-color: #f59e0b;}
        .is-me .avatar { border-color: #3b82f6; background: #172554;}
        .dead { opacity: 0.4; filter: grayscale(100%); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙŠØ¯ */
        .my-hand { height: 160px; width: 100%; background: linear-gradient(to top, #1a0505 20%, transparent); display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; z-index: 50; overflow-x: auto;}
        .hand-card { width: 85px; transition: transform 0.2s; margin-left: -40px; cursor: pointer; border-radius: 6px; box-shadow: -3px 0 12px rgba(0,0,0,0.6); position: relative; transform-origin: bottom center;}
        .hand-card:first-child { margin-left: 0; }
        .hand-card.selected { transform: translateY(-40px) scale(1.1); z-index: 100; outline: 3px solid #f59e0b; box-shadow: 0 15px 30px rgba(0,0,0,0.8);}
        .hand-card img { width: 100%; border-radius: 6px; display: block;}

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .controls { position: absolute; bottom: 190px; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none; z-index: 60;}
        .btn { pointer-events: auto; padding: 12px 35px; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.6); transition: 0.2s; min-width: 140px; text-shadow: 0 2px 2px rgba(0,0,0,0.3);}
        .btn:active { transform: scale(0.95); box-shadow: 0 2px 10px rgba(0,0,0,0.4);}
        .btn-play { background: linear-gradient(to bottom, #2563eb, #1d4ed8); border-bottom: 4px solid #1e3a8a; }
        .btn-liar { background: linear-gradient(to bottom, #dc2626, #b91c1c); border-bottom: 4px solid #7f1d1d; }
        
        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ (Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ§Ù„Ø±ÙˆÙ„ÙŠØª) */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5, 5, 5, 0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(5px);}
        
        .lobby-box { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .room-code-display { font-size: 5rem; font-weight: 900; color: #dc2626; letter-spacing: 8px; margin: 10px 0; text-shadow: 0 0 20px rgba(220, 38, 38, 0.4); font-family: monospace;}
        .joined-players { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; min-height: 50px;}
        .lobby-avatar { width: 40px; height: 40px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid #555;}

        .start-btn { padding: 15px 40px; font-size: 1.6rem; background: linear-gradient(to bottom, #16a34a, #15803d); color: white; border: none; border-radius: 12px; cursor: pointer; border-bottom: 5px solid #14532d; width: 100%; transition: 0.2s;}
        .start-btn:active { transform: translateY(4px); border-bottom-width: 0px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´Ù */
        .reveal-grid { display: flex; gap: 10px; margin-top: 20px;}
        .reveal-card-img { width: 80px; border-radius: 8px; box-shadow: 0 0 15px white;}
        .truth-glow img { box-shadow: 0 0 30px #22c55e; border: 3px solid #22c55e;}
        .liar-glow img { box-shadow: 0 0 30px #ef4444; border: 3px solid #ef4444;}

    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');
        const isHost = urlParams.get('role') === 'host';

        const storageKey = `liars_v3_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) { myId = "p_" + Date.now(); localStorage.setItem(storageKey, myId); }

        const rootRef = `liars_rooms/${pin}`;
        const myPlayerRef = ref(db, `${rootRef}/players/${myId}`);
        const playersRef = ref(db, `${rootRef}/players`);
        const stateRef = ref(db, `${rootRef}/gameState`);
        const actionsRef = ref(db, `${rootRef}/actions`);

        const CARD_IMGS = {
            'K': 'https://deckofcardsapi.com/static/img/KH.png', 'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png', 'A': 'https://deckofcardsapi.com/static/img/AS.png',
            '10': 'https://deckofcardsapi.com/static/img/0S.png', 'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png'
        };

        let gameState = { status: 'lobby', tableStack: [] };
        let players = {};
        let myHand = [];
        let selectedIndices = [];

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        get(myPlayerRef).then((snap) => {
            if (!snap.exists()) {
                set(myPlayerRef, { 
                    name: myName, isAlive: true, hand: [], 
                    bulletIndex: Math.floor(Math.random() * 6), currentChamber: 0 
                });
            } else {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
                if(snap.val().name) myName = snap.val().name;
            }
        });

        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            myHand = players[myId]?.hand || [];
            renderTable();
            renderHand();
            updateLobbyUI(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || { status: 'lobby', tableStack: [] };
            renderUI();
            renderPile();
        });

        // ----------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‡ÙˆØ³Øª (ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©)
        // ----------------------------------------------------
        if (isHost) {
            window.hostStartGame = async function() {
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive);
                if (aliveIds.length < 2) return alert("Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");

                // --- Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ù„Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯Ù„ ---
                const numPlayers = aliveIds.length;
                const handSizes = [5, 6, 7, 8]; // Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
                let chosenSize = 6;
                let jokersNeeded = 0;
                let cardsPerType = 0;
                let foundSolution = false;

                // Ù†Ø¬Ø±Ø¨ ÙƒÙ„ Ø­Ø¬Ù… ÙŠØ¯ Ù„Ù†Ø±Ù‰ Ø£ÙŠÙ‡Ù… ÙŠØ¹Ø·ÙŠ Ù‚Ø³Ù…Ø© ØµØ­ÙŠØ­Ø© Ø¹Ù„Ù‰ 5 Ø£Ù†ÙˆØ§Ø¹
                for (let size of handSizes) {
                    let totalCards = size * numPlayers;
                    // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Total - Jokers) / 5 = Integer
                    // Ù†Ø¬Ø±Ø¨ 0 Ø¬ÙˆÙƒØ±ØŒ 1 Ø¬ÙˆÙƒØ±ØŒ 2 Ø¬ÙˆÙƒØ±
                    for (let j = 0; j <= 2; j++) {
                        let remainder = (totalCards - j) % 5;
                        if (remainder === 0) {
                            chosenSize = size;
                            jokersNeeded = j;
                            cardsPerType = (totalCards - j) / 5;
                            foundSolution = true;
                            break;
                        }
                    }
                    if (foundSolution) break;
                }

                // Ø¨Ù†Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙˆØ±Ù‚ (Deck)
                let deck = [];
                ['K', 'Q', 'J', 'A', '10'].forEach(type => {
                    for(let k=0; k < cardsPerType; k++) deck.push(type);
                });
                for(let k=0; k < jokersNeeded; k++) deck.push('Joker');

                // Ø®Ù„Ø· Ø§Ù„ÙˆØ±Ù‚
                deck.sort(() => Math.random() - 0.5);

                // Ø§Ù„ØªÙˆØ²ÙŠØ¹
                let updates = {};
                aliveIds.forEach(id => {
                    let hand = deck.splice(0, chosenSize);
                    updates[`players/${id}/hand`] = hand;
                });

                const target = ['K', 'Q', 'J', 'A', '10'][Math.floor(Math.random() * 5)];
                const firstTurn = aliveIds[Math.floor(Math.random() * aliveIds.length)];

                updates[`gameState`] = {
                    status: 'playing',
                    targetCard: target,
                    turnId: firstTurn,
                    tableStack: [],
                    lastPlay: null
                };

                await update(ref(db, rootRef), updates);
            };

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙƒØ´Ù†
            onChildAdded(actionsRef, async (snap) => {
                const action = snap.val();
                const key = snap.key;
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive).sort(); 

                if (action.type === 'play') {
                    let stack = gameState.tableStack || [];
                    const visualCards = action.cards.map(() => ({ rot: Math.random()*360, x: Math.random()*20-10, y: Math.random()*20-10 }));
                    
                    const currIdx = aliveIds.indexOf(action.playerId);
                    const nextId = aliveIds[(currIdx + 1) % aliveIds.length];

                    await update(stateRef, {
                        tableStack: stack.concat(visualCards),
                        turnId: nextId,
                        lastPlay: { playerId: action.playerId, cards: action.cards }
                    });
                }
                else if (action.type === 'liar') {
                    const lastMove = gameState.lastPlay;
                    const accuser = players[action.playerId].name;
                    const accused = players[lastMove.playerId].name;
                    
                    let isLiar = false;
                    lastMove.cards.forEach(card => {
                        if (card !== gameState.targetCard && card !== 'Joker') isLiar = true;
                    });

                    let victimId = isLiar ? lastMove.playerId : action.playerId;
                    
                    await update(stateRef, {
                        status: 'reveal', revealedCards: lastMove.cards, isLiar: isLiar, victimId: victimId,
                        msg: isLiar ? `ÙƒØ´ÙÙ†Ø§Ùƒ! ${accused} ÙƒØ§Ø°Ø¨!` : `ØµØ§Ø¯Ù‚! ${accuser} Ø¸Ù„Ù…ØªÙ‡!`
                    });

                    setTimeout(() => update(stateRef, { status: 'roulette' }), 6000);
                }
                else if (action.type === 'shoot') {
                    const victim = players[action.playerId];
                    if (victim.currentChamber === victim.bulletIndex) {
                        await update(ref(db, `${rootRef}/players/${action.playerId}`), { isAlive: false });
                        const survivors = aliveIds.filter(id => id !== action.playerId);
                        if (survivors.length === 1) {
                            await update(stateRef, { status: 'winner', winner: players[survivors[0]].name });
                        } else {
                            setTimeout(() => window.hostStartGame(), 3000);
                        }
                    } else {
                        await update(ref(db, `${rootRef}/players/${action.playerId}`), { currentChamber: victim.currentChamber + 1 });
                        setTimeout(() => window.hostStartGame(), 3000);
                    }
                }
                remove(ref(db, `${rootRef}/actions/${key}`));
            });
        }

        // ----------------------------------------------------
        // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // ----------------------------------------------------
        
        function renderTable() {
            const container = document.getElementById('playersRing');
            container.innerHTML = '';
            
            const pKeys = Object.keys(players).sort();
            if (pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;
            const count = pKeys.length;
            
            pKeys.forEach((id, i) => {
                let relativeI = (i - myIndex + count) % count;
                let angle = (relativeI / count) * (2 * Math.PI) + (Math.PI / 2);
                
                let rx = 42; let ry = 38;
                let left = 50 + (Math.cos(angle) * rx); 
                let top = 45 + (Math.sin(angle) * ry); 

                const p = players[id];
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isDead = !p.isAlive ? 'dead' : '';
                const isMe = id === myId ? 'is-me' : '';
                const gunInfo = p.isAlive ? `ğŸ”« ${p.currentChamber}/6` : 'ğŸ’€';

                const el = document.createElement('div');
                el.className = `player-seat ${isActive} ${isDead} ${isMe}`;
                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.innerHTML = `
                    <div class="avatar"><span>ğŸ‘¤</span></div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-gun">${gunInfo}</div>
                `;
                container.appendChild(el);
            });
        }

        function renderPile() {
            const pile = document.getElementById('discardPile');
            const stack = gameState.tableStack || [];
            
            if (pile.childElementCount !== stack.length) {
                pile.innerHTML = '';
                stack.forEach((cardMeta, i) => {
                    const card = document.createElement('div');
                    card.className = 'thrown-card';
                    card.style.transform = `rotate(${cardMeta.rot}deg) translate(${cardMeta.x}px, ${cardMeta.y}px)`;
                    card.style.zIndex = i;
                    pile.appendChild(card);
                });
            }
        }

        function renderHand() {
            const handDiv = document.getElementById('myHand');
            handDiv.innerHTML = '';
            if (!myHand) return;

            myHand.forEach((cardCode, i) => {
                const img = document.createElement('img');
                img.src = CARD_IMGS[cardCode] || CARD_IMGS['10']; 
                const div = document.createElement('div');
                div.className = `hand-card ${selectedIndices.includes(i) ? 'selected' : ''}`;
                div.onclick = () => toggleSelect(i);
                div.appendChild(img);
                handDiv.appendChild(div);
            });
        }

        window.toggleSelect = (i) => {
            if (gameState.status !== 'playing' || gameState.turnId !== myId) return;
            if (selectedIndices.includes(i)) selectedIndices = selectedIndices.filter(x => x !== i);
            else selectedIndices.push(i);
            renderHand();
            updateBtns();
        };

        function updateBtns() {
            const btnPlay = document.getElementById('btnPlay');
            const btnLiar = document.getElementById('btnLiar');
            if (gameState.turnId === myId) {
                btnPlay.disabled = selectedIndices.length === 0;
                btnPlay.style.opacity = btnPlay.disabled ? 0.5 : 1;
                btnLiar.disabled = (gameState.tableStack || []).length === 0;
                btnLiar.style.opacity = btnLiar.disabled ? 0.5 : 1;
                document.getElementById('controls').style.display = 'flex';
            } else {
                document.getElementById('controls').style.display = 'none';
            }
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            if(list) {
                list.innerHTML = '';
                Object.values(players).forEach(p => {
                    list.innerHTML += `<div class="lobby-avatar" title="${p.name}">ğŸ‘¤</div>`;
                });
                document.getElementById('lobbyCount').innerText = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${Object.keys(players).length}`;
            }
        }

        function renderUI() {
            const target = gameState.targetCard || '?';
            document.getElementById('targetIcon').innerText = target;
            document.getElementById('targetText').innerText = `Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${target}`;
            document.getElementById('pinDisplay').innerText = `PIN: ${pin}`;

            const overlay = document.getElementById('overlay');
            
            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                if (isHost) {
                    overlay.innerHTML = `
                        <div class="lobby-box">
                            <div style="color:#aaa; font-size:1.2rem;">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ù„Ù„Ø¯Ø®ÙˆÙ„)</div>
                            <div class="room-code-display">${pin}</div>
                            <div id="lobbyCount" style="color:#f59e0b; font-weight:bold; margin-top:10px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: 0</div>
                            <div class="joined-players" id="lobbyList"></div>
                            <button class="start-btn" onclick="triggerStart()">ğŸ‘‘ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                        </div>
                    `;
                    updateLobbyUI();
                } else {
                    overlay.innerHTML = `
                        <div class="lobby-box">
                            <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${myName}</h2>
                            <p style="color:#aaa;">Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù‡ÙˆØ³Øª ÙŠØ¨Ø¯Ø£...</p>
                            <div class="joined-players" id="lobbyList"></div>
                        </div>`;
                    updateLobbyUI();
                }
            }
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                updateBtns();
            }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                const glowClass = gameState.isLiar ? 'liar-glow' : 'truth-glow';
                const cardsHTML = (gameState.revealedCards || []).map(c => 
                    `<div class="${glowClass} reveal-card-img"><img src="${CARD_IMGS[c]}" style="width:100%; border-radius:8px;"></div>`
                ).join('');
                
                overlay.innerHTML = `
                    <h1 style="color:${gameState.isLiar ? '#ef4444' : '#22c55e'}; font-size:2.5rem; margin-bottom:20px;">${gameState.msg}</h1>
                    <div class="reveal-grid">${cardsHTML}</div>
                `;
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlay.innerHTML = `
                        <h1 style="color:red; font-size:3rem;">Ø¯ÙˆØ±Ùƒ ÙŠØ§ Ø¨Ø·Ù„ ğŸ’€</h1>
                        <p style="color:#ccc; margin-bottom:30px;">Ø§Ø¶ØºØ· Ø§Ù„Ø²Ù†Ø§Ø¯ ÙˆØ´ÙˆÙ Ø­Ø¸Ùƒ</p>
                        <button class="start-btn" style="background:#dc2626; border-bottom-color:#991b1b;" onclick="triggerShoot()">ğŸ”¥ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø±</button>
                    `;
                } else {
                    const victimName = players[gameState.victimId]?.name || 'Ø§Ù„Ø¶Ø­ÙŠØ©';
                    overlay.innerHTML = `<h1 style="font-size:5rem;">ğŸ”«</h1><h2>${victimName} ÙŠØ·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±...</h2>`;
                }
            }
            else if (gameState.status === 'winner') {
                overlay.style.display = 'flex';
                overlay.innerHTML = `
                    <h1 style="color:gold; font-size:5rem; margin:0;">ğŸ†</h1>
                    <h2 style="margin:10px 0;">Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²!</h2>
                    <h1 style="color:#fcd34d;">${gameState.winner}</h1>
                    ${isHost ? '<button class="start-btn" style="margin-top:30px;" onclick="triggerStart()">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ”„</button>' : ''}
                `;
            }
        }

        window.triggerStart = () => { if(isHost) window.hostStartGame(); };
        
        window.playAction = () => {
            const cards = selectedIndices.map(i => myHand[i]);
            push(actionsRef, { type: 'play', playerId: myId, cards: cards });
            myHand = myHand.filter((_, i) => !selectedIndices.includes(i));
            selectedIndices = [];
            renderHand();
            document.getElementById('controls').style.display = 'none';
        };

        window.liarAction = () => {
            if(confirm("Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ÙƒØ°Ø§Ø¨ØŸ Ø¥Ø°Ø§ Ø·Ù„Ø¹ ØµØ§Ø¯Ù‚ Ø¨ØªÙ…ÙˆØª Ø£Ù†Øª!")) push(actionsRef, { type: 'liar', playerId: myId });
        };

        window.triggerShoot = () => {
            push(actionsRef, { type: 'shoot', playerId: myId });
            document.getElementById('overlay').innerHTML = `<h2>...</h2>`;
        };

    </script>
</head>
<body>

    <div class="top-info-bar">
        <div class="room-pin-top" id="pinDisplay">PIN: ----</div>
        <div class="target-display">
            <div class="target-icon" id="targetText">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: K</div>
            <div style="display:none;" id="targetIcon"></div>
        </div>
    </div>

    <div class="table-area">
        <div id="playersRing" style="width:100%; height:100%; position:absolute;"></div>
        
        <div class="table-felt">
            <div class="discard-pile" id="discardPile"></div>
        </div>
    </div>

    <div id="controls" class="controls" style="display:none;">
        <button class="btn btn-play" id="btnPlay" onclick="playAction()">â¬‡ï¸ Ø§Ù†Ø²Ù„</button>
        <button class="btn btn-liar" id="btnLiar" onclick="liarAction()">ğŸ¤¥ ÙƒØ°Ø§Ø¨</button>
    </div>

    <div class="my-hand" id="myHand"></div>

    <div class="overlay" id="overlay">
        <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
    </div>

</body>
</html>
