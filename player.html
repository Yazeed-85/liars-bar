<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liar's Bar</title>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #0a0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #1a0505 0%, #000 100%); touch-action: manipulation;}
        
        /* --- 1. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0,0,0,0.9); border-bottom: 2px solid #451a03; height: 85px; flex-shrink: 0; z-index: 20;}
        .room-pin { font-family: monospace; color: #888; font-size: 1.1rem; background: #111; padding: 5px 10px; border-radius: 8px; border: 1px solid #333; cursor: pointer;}
        .room-pin:active { color: #fff; border-color: #f59e0b; }
        
        .turn-indicator { flex: 1; text-align: center; font-size: 1.2rem; font-weight: bold;}
        .turn-indicator .highlight { color: #f59e0b; font-size: 1.4rem; text-shadow: 0 0 10px rgba(245, 158, 11, 0.6);}
        .turn-indicator.my-turn .highlight { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.6);}

        .target-box { display: flex; align-items: center; gap: 10px; background: #3f1808; padding: 5px 15px; border-radius: 12px; border: 1px solid #f59e0b;}
        .target-img-container { width: 35px; height: 50px; display: flex; justify-content: center; align-items: center; }
        .target-img-container img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; animation: glowTarget 1.5s infinite alternate; border: 1px solid #fff;}
        @keyframes glowTarget { from { filter: drop-shadow(0 0 2px #f59e0b); } to { filter: drop-shadow(0 0 8px #f59e0b); transform: scale(1.05); } }

        /* --- 2. Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ³Ø·Ù‰ (Ø§Ù„Ø·Ø§ÙˆÙ„Ø©) --- */
        .arena { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%; padding: 20px;}
        .table { width: 60vmin; height: 60vmin; max-width: 400px; max-height: 400px; background: radial-gradient(circle, #065f46 0%, #022c22 100%); border-radius: 50%; border: 12px solid #451a03; box-shadow: inset 0 0 40px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.7); position: relative; display: flex; justify-content: center; align-items: center; z-index: 1;}
        .discard-pile { position: absolute; width: 60px; height: 85px; top: 50%; left: 50%; transform: translate(-50%, -50%);}
        .thrown-card { position: absolute; width: 60px; height: 85px; background-image: url('https://deckofcardsapi.com/static/img/back.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 4px; box-shadow: 2px 2px 8px rgba(0,0,0,0.8); top: 0; left: 0;}

        /* Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-seat { position: absolute; width: 90px; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); z-index: 10;}
        .avatar-container { position: relative; width: 55px; height: 55px; display: flex; justify-content: center; align-items: center;}
        .avatar { width: 100%; height: 100%; background: #1f2937; border-radius: 50%; border: 3px solid #4b5563; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 2; transition: all 0.3s;}
        .p-name { background: rgba(0,0,0,0.9); padding: 3px 10px; border-radius: 10px; font-size: 0.8rem; margin-top: -8px; z-index: 3; border: 1px solid #444; white-space: nowrap; max-width: 90px; overflow: hidden; text-overflow: ellipsis; font-weight: bold;}
        .p-gun { font-size: 0.75rem; color: #ef4444; background: #111; padding: 2px 6px; border-radius: 4px; margin-top: 4px; font-weight: bold; border: 1px solid #333;}
        
        .active-turn .avatar { border-color: #f59e0b; transform: scale(1.2); box-shadow: 0 0 25px #f59e0b;}
        .active-turn .p-name { color: #f59e0b; border-color: #f59e0b;}
        .is-me .avatar { border-color: #3b82f6; background: #1e3a8a;}
        .dead { opacity: 0.4; filter: grayscale(100%); }
        .dead .p-name { text-decoration: line-through; color: #666;}
        .flying-card-anim { position: absolute; width: 60px; height: 85px; border-radius: 4px; z-index: 100; transition: all 0.4s ease-out; box-shadow: 0 15px 30px rgba(0,0,0,0.8);}

        /* --- 3. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .bottom-area { background: #110808; border-top: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 20; height: 210px; flex-shrink: 0; position: relative;}
        .controls { display: flex; gap: 15px; margin-bottom: 10px; width: 90%; max-width: 500px;}
        .btn { flex: 1; padding: 12px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: linear-gradient(135deg, #2563eb, #1e3a8a); border-bottom: 4px solid #172554;}
        .btn-liar { background: linear-gradient(135deg, #dc2626, #7f1d1d); border-bottom: 4px solid #450a0a;}
        .my-hand { height: 110px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; width: 100%; overflow-x: auto;}
        .hand-card { min-width: 65px; max-width: 75px; aspect-ratio: 5/7; margin-left: -30px; cursor: pointer; transition: 0.2s; position: relative;}
        .hand-card:first-child { margin-left: 0; }
        .hand-card img { width: 100%; height: 100%; object-fit: contain; border-radius: 5px; box-shadow: -3px 0 10px rgba(0,0,0,0.8); display: block; background: #fff;}
        .hand-card.selected { transform: translateY(-20px); z-index: 50;}
        .hand-card.selected img { outline: 3px solid #f59e0b; box-shadow: 0 10px 20px rgba(245,158,11,0.8);}
        .spectator-mode { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 60; display: none; flex-direction: column; justify-content: center; align-items: center; border-top: 2px solid #dc2626;}

        /* --- 4. Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ (Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ§Ù„Ù…ÙˆØª) --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5,5,5,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(5px);}
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ÙˆØ¨ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .lobby-box { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 1px solid #333; width: 90%; max-width: 600px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .room-code-display { font-size: 4rem; font-weight: 900; color: #dc2626; letter-spacing: 5px; margin: 10px 0; font-family: monospace; cursor: pointer; transition: 0.2s;}
        .room-code-display:active { transform: scale(0.95); color: #fff;}
        .copy-hint { font-size: 0.8rem; color: #666; margin-bottom: 20px;}
        
        .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; margin: 20px 0; max-height: 300px; overflow-y: auto;}
        .lobby-player { display: flex; flex-direction: column; align-items: center;}
        .lobby-avatar { width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid #555; font-size: 24px;}
        .lobby-name { font-size: 0.8rem; margin-top: 5px; color: #ccc; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}

        .start-btn { padding: 15px 40px; font-size: 1.5rem; background: linear-gradient(#16a34a, #15803d); color: white; border: none; border-radius: 12px; cursor: pointer; border-bottom: 5px solid #14532d; width: 100%; margin-top: 10px; transition: 0.2s;}
        .start-btn:active { transform: translateY(4px); border-bottom-width: 0px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .result-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 2px solid #333; box-shadow: 0 20px 50px #000; width: 90%; max-width: 500px;}
        .reveal-cards { display: flex; gap: 10px; margin: 20px 0; justify-content: center;}
        .reveal-cards img { width: 80px; border-radius: 6px; box-shadow: 0 0 15px rgba(255,255,255,0.2);}
        .truth-glow img { box-shadow: 0 0 40px #10b981; border: 3px solid #10b981;}
        .liar-glow img { box-shadow: 0 0 40px #dc2626; border: 3px solid #dc2626;}
        
        /* Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø³ÙˆØ® */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none;}
        .toast.show { opacity: 1; bottom: 50px;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');
        const isHost = urlParams.get('role') === 'host';

        const storageKey = `liars_v10_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) { myId = "p_" + Date.now(); localStorage.setItem(storageKey, myId); }

        const rootRef = `liars_rooms/${pin}`;
        const myPlayerRef = ref(db, `${rootRef}/players/${myId}`);
        const playersRef = ref(db, `${rootRef}/players`);
        const stateRef = ref(db, `${rootRef}/gameState`);
        const actionsRef = ref(db, `${rootRef}/actions`);
        const eventsRef = ref(db, `${rootRef}/events`);

        const CARD_IMGS = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png', 
            'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png', 
            'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        let gameState = { status: 'lobby', tableStack: [] };
        let players = {};
        let myHand = [];
        let selectedIndices = [];

        get(myPlayerRef).then((snap) => {
            if (!snap.exists()) {
                set(myPlayerRef, { name: myName, isAlive: true, hand: [], bulletIndex: Math.floor(Math.random() * 6), currentChamber: 0 });
            } else { if(snap.val().name) myName = snap.val().name; }
        });

        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            const newHand = players[myId]?.hand || [];
            if (JSON.stringify(newHand) !== JSON.stringify(myHand)) { myHand = newHand; }
            renderTable(); renderHand(); renderUI();
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || { status: 'lobby', tableStack: [] };
            renderTable(); renderUI(); renderPile();
        });

        onChildAdded(eventsRef, (snap) => {
            const ev = snap.val();
            if (ev.type === 'throw' && (Date.now() - ev.time < 3000)) animateThrow(ev.playerId, ev.count);
        });

        // ----------------------------------------------------
        // Ø§Ù„Ù…Ù†Ø·Ù‚
        // ----------------------------------------------------
        if (isHost) {
            window.hostStartGame = async function() {
                const allIds = Object.keys(players);
                if (allIds.length < 2) return alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©!");

                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹ (4 Ø£Ù†ÙˆØ§Ø¹ ÙÙ‚Ø·)
                const numPlayers = allIds.length;
                let chosenSize = 6, jokersNeeded = 0, cardsPerType = 0, found = false;

                for (let size of [6, 5, 7, 8, 4]) {
                    let totalCards = size * numPlayers;
                    let remainder = totalCards % 4;
                    if (remainder <= 2) { // Ù†Ø³Ù…Ø­ Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 Ø¬ÙˆÙƒØ±
                        chosenSize = size; jokersNeeded = remainder; cardsPerType = Math.floor(totalCards / 4); found = true; break;
                    }
                }
                if (!found) { chosenSize = 6; jokersNeeded = 0; cardsPerType = Math.ceil((6 * numPlayers)/4); }

                let deck = [];
                ['A', 'K', 'Q', 'J'].forEach(type => { for(let k=0; k < cardsPerType; k++) deck.push(type); });
                for(let k=0; k < jokersNeeded; k++) deck.push('Joker');
                deck.sort(() => Math.random() - 0.5);

                let updates = {};
                allIds.forEach(id => { 
                    updates[`players/${id}/isAlive`] = true;
                    updates[`players/${id}/hand`] = deck.splice(0, chosenSize);
                });

                const target = ['A', 'K', 'Q', 'J'][Math.floor(Math.random() * 4)];
                const firstTurn = allIds[Math.floor(Math.random() * allIds.length)];

                updates[`gameState`] = { status: 'playing', targetCard: target, turnId: firstTurn, tableStack: [], lastPlay: null };
                await update(ref(db, rootRef), updates);
            };

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙƒØ´Ù†Ø§Øª (Ø±Ù…ÙŠØŒ ØªÙƒØ°ÙŠØ¨ØŒ Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø±)
            onChildAdded(actionsRef, async (snap) => {
                const action = snap.val();
                const key = snap.key;
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive).sort(); 
                
                try {
                    if (action.type === 'play') {
                        let stack = gameState.tableStack || [];
                        const visualCards = action.cards.map(() => ({ rot: Math.random()*60 - 30, x: Math.random()*20 - 10, y: Math.random()*20 - 10 }));
                        
                        const evRef = push(eventsRef, { type: 'throw', playerId: action.playerId, count: action.cards.length, time: Date.now() });
                        setTimeout(() => remove(evRef), 4000);

                        const currIdx = aliveIds.indexOf(action.playerId);
                        const nextId = aliveIds[(currIdx + 1) % aliveIds.length];

                        await update(stateRef, { tableStack: stack.concat(visualCards), turnId: nextId, lastPlay: { playerId: action.playerId, cards: action.cards } });
                    }
                    else if (action.type === 'liar') {
                        const lastMove = gameState.lastPlay;
                        let isLiar = false;
                        lastMove.cards.forEach(card => { if (card !== gameState.targetCard && card !== 'Joker') isLiar = true; });

                        let victimId = isLiar ? lastMove.playerId : action.playerId;
                        
                        await update(stateRef, {
                            status: 'reveal', revealedCards: lastMove.cards, isLiar: isLiar, victimId: victimId,
                            msg: isLiar ? `ÙƒØ´ÙÙ†Ø§Ù‡! ${players[lastMove.playerId].name} ÙƒØ°Ø§Ø¨!` : `ØµØ§Ø¯Ù‚! ${players[action.playerId].name} ØªØ³Ø±Ù‘Ø¹!`
                        });

                        setTimeout(() => update(stateRef, { status: 'roulette' }), 5000);
                    }
                    else if (action.type === 'shoot') {
                        const victim = players[action.playerId];
                        const died = victim.currentChamber === victim.bulletIndex;
                        
                        await update(stateRef, { status: 'shot_result', died: died, victimName: victim.name });

                        if (died) {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { isAlive: false });
                            const survivors = aliveIds.filter(id => id !== action.playerId);
                            if (survivors.length === 1) {
                                setTimeout(() => update(stateRef, { status: 'winner', winner: players[survivors[0]].name }), 5000);
                            } else {
                                setTimeout(() => window.hostStartGame(), 5000);
                            }
                        } else {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { currentChamber: victim.currentChamber + 1 });
                            setTimeout(() => window.hostStartGame(), 5000);
                        }
                    }
                } catch(e) { console.error(e); }
                remove(ref(db, `${rootRef}/actions/${key}`));
            });
        }

        // ----------------------------------------------------
        // Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª
        // ----------------------------------------------------
        function renderTable() {
            const container = document.getElementById('playersRing');
            container.innerHTML = '';
            const pKeys = Object.keys(players).sort();
            if (pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;
            const count = pKeys.length;
            
            pKeys.forEach((id, i) => {
                let relativeI = (i - myIndex + count) % count;
                let angle = (Math.PI / 2) - (relativeI / count) * (2 * Math.PI);
                let rx = 45; let ry = 42;
                let left = 50 + (Math.cos(angle) * rx); 
                let top = 50 + (Math.sin(angle) * ry); 

                const p = players[id];
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isDead = !p.isAlive ? 'dead' : '';
                const isMe = id === myId ? 'is-me' : '';
                const gunInfo = p.isAlive ? `ğŸ”« ${p.currentChamber}/6` : 'ğŸ’€';

                const el = document.createElement('div');
                el.className = `player-seat ${isActive} ${isDead} ${isMe}`;
                el.id = `avatar-${id}`;
                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.innerHTML = `<div class="avatar-container"><div class="avatar"><span>ğŸ‘¤</span></div></div><div class="p-name">${id === myId ? '(Ø£Ù†Øª) '+p.name : p.name}</div><div class="p-gun">${gunInfo}</div>`;
                container.appendChild(el);
            });
        }

        window.animateThrow = function(playerId, count) {
            const avatar = document.getElementById(`avatar-${playerId}`);
            const tableCenter = document.getElementById('discardPile');
            if(!avatar || !tableCenter) return;
            const startRect = avatar.getBoundingClientRect();
            const endRect = tableCenter.getBoundingClientRect();

            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const card = document.createElement('div');
                    card.style.backgroundImage = `url('${CARD_IMGS['Back']}')`;
                    card.style.backgroundSize = 'contain';
                    card.className = 'flying-card-anim';
                    card.style.left = `${startRect.left + 10}px`; card.style.top = `${startRect.top + 10}px`;
                    document.body.appendChild(card);
                    setTimeout(() => {
                        card.style.left = `${endRect.left + (Math.random()*10 - 5)}px`;
                        card.style.top = `${endRect.top + (Math.random()*10 - 5)}px`;
                        card.style.transform = `rotate(${Math.random() * 90 - 45}deg) scale(0.9)`;
                    }, 50);
                    setTimeout(() => card.remove(), 400);
                }, i * 150);
            }
        }

        function renderPile() {
            const pile = document.getElementById('discardPile');
            const stack = gameState.tableStack || [];
            if (pile.childElementCount !== stack.length) {
                pile.innerHTML = '';
                stack.forEach((meta, i) => {
                    const card = document.createElement('div');
                    card.className = 'thrown-card';
                    card.style.transform = `rotate(${meta.rot}deg) translate(${meta.x}px, ${meta.y}px)`;
                    card.style.zIndex = i;
                    pile.appendChild(card);
                });
            }
        }

        function renderHand() {
            const handDiv = document.getElementById('myHand');
            handDiv.innerHTML = '';
            if (!myHand || myHand.length === 0) return;
            myHand.forEach((cardCode, i) => {
                const img = document.createElement('img');
                img.src = CARD_IMGS[cardCode] || CARD_IMGS['Back']; 
                const div = document.createElement('div');
                div.className = `hand-card ${selectedIndices.includes(i) ? 'selected' : ''}`;
                div.onclick = () => toggleSelect(i);
                div.appendChild(img);
                handDiv.appendChild(div);
            });
        }

        window.toggleSelect = (i) => {
            if (gameState.status !== 'playing' || gameState.turnId !== myId || !players[myId].isAlive) return;
            if (selectedIndices.includes(i)) selectedIndices = selectedIndices.filter(x => x !== i);
            else selectedIndices.push(i);
            renderHand(); updateBtns();
        };

        window.playAction = () => {
            if (selectedIndices.length === 0) return;
            document.getElementById('btnPlay').disabled = true;
            const cards = selectedIndices.map(i => myHand[i]);
            myHand = myHand.filter((_, i) => !selectedIndices.includes(i));
            set(ref(db, `${rootRef}/players/${myId}/hand`), myHand);
            push(actionsRef, { type: 'play', playerId: myId, cards: cards });
            selectedIndices = [];
            renderHand(); 
        };

        window.liarAction = () => { if(confirm("Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ§Ø¯Ù‚Ø§Ù‹ Ø³ØªÙ…ÙˆØª Ø£Ù†Øª! Ù…ØªØ£ÙƒØ¯ØŸ")) push(actionsRef, { type: 'liar', playerId: myId }); };
        window.triggerShoot = () => { push(actionsRef, { type: 'shoot', playerId: myId }); document.getElementById('overlay').innerHTML = `<h2>...</h2>`; };
        window.triggerStart = () => { if(isHost) window.hostStartGame(); };
        window.copyPin = () => {
            navigator.clipboard.writeText(pin);
            const t = document.getElementById('toast'); t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        function updateBtns() {
            const btnPlay = document.getElementById('btnPlay');
            const btnLiar = document.getElementById('btnLiar');
            if (gameState.turnId === myId && players[myId]?.isAlive) {
                btnPlay.disabled = selectedIndices.length === 0;
                btnLiar.disabled = (gameState.tableStack || []).length === 0;
            } else { btnPlay.disabled = true; btnLiar.disabled = true; }
        }

        function renderUI() {
            if (gameState.targetCard) document.getElementById('targetDisplay').innerHTML = `<img src="${CARD_IMGS[gameState.targetCard]}">`;
            document.getElementById('pinDisplay').innerText = `PIN: ${pin}`;

            const turnInd = document.getElementById('turnIndicator');
            if (players[myId] && !players[myId].isAlive && gameState.status !== 'lobby') {
                document.getElementById('spectatorMode').style.display = 'flex';
                turnInd.innerHTML = "ğŸ‘€ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
            } else {
                document.getElementById('spectatorMode').style.display = 'none';
                if (gameState.status === 'playing') {
                    if (gameState.turnId === myId) {
                        turnInd.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ÙŠØ§ <span class="highlight">${myName}</span>!`;
                        turnInd.className = 'turn-indicator my-turn';
                    } else {
                        const tName = players[gameState.turnId] ? players[gameState.turnId].name : '...';
                        turnInd.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span class="highlight">${tName}</span>`;
                        turnInd.className = 'turn-indicator';
                    }
                    updateBtns();
                }
            }

            const overlay = document.getElementById('overlay');
            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                let playersListHTML = Object.values(players).map(p => `
                    <div class="lobby-player">
                        <div class="lobby-avatar">ğŸ‘¤</div>
                        <div class="lobby-name">${p.name}</div>
                    </div>`).join('');

                if (isHost) {
                    overlay.innerHTML = `
                        <div class="lobby-box">
                            <h2 style="color:#aaa">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®):</h2>
                            <div class="room-code-display" onclick="copyPin()">${pin}</div>
                            <div class="copy-hint">ØªÙ… Ø§Ù†Ø¶Ù…Ø§Ù… ${Object.keys(players).length} Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
                            <div class="players-grid">${playersListHTML}</div>
                            <button class="start-btn" onclick="triggerStart()">ğŸ² Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                        </div>`;
                } else {
                    overlay.innerHTML = `
                        <div class="lobby-box">
                            <h2>Ø£Ù‡Ù„Ø§Ù‹ ${myName}</h2>
                            <p style="color:#aaa;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡ÙˆØ³Øª...</p>
                            <div class="players-grid">${playersListHTML}</div>
                        </div>`;
                }
            }
            else if (gameState.status === 'playing') { overlay.style.display = 'none'; }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                const glow = gameState.isLiar ? 'liar-glow' : 'truth-glow';
                const cardsHTML = (gameState.revealedCards || []).map(c => `<div class="${glow} reveal-card-img"><img src="${CARD_IMGS[c] || CARD_IMGS['Back']}" style="width:100%; display:block; border-radius:6px;"></div>`).join('');
                overlay.innerHTML = `<div class="result-box"><h1 style="color:${gameState.isLiar ? '#ef4444' : '#10b981'}; font-size:2rem; margin-bottom:20px;">${gameState.msg}</h1><div class="reveal-cards">${cardsHTML}</div></div>`;
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlay.innerHTML = `<div class="result-box" style="border-color:#dc2626"><h1 style="color:#ef4444; font-size:2.5rem">Ø¯ÙˆØ±Ùƒ ÙŠØ§ Ø¨Ø·Ù„!</h1><p style="margin:20px 0;">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯...</p><button class="start-btn" style="background:#dc2626;" onclick="triggerShoot()">ğŸ”« Ø¥Ø·Ù„Ø§Ù‚</button></div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem">ğŸ”«</h1><h2>${players[gameState.victimId]?.name} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³...</h2></div>`;
                }
            }
            else if (gameState.status === 'shot_result') {
                overlay.style.display = 'flex';
                if (gameState.died) {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ’¥</h1><h1 style="color:#ef4444">Ø¨Ù€Ù€Ù€ÙˆÙˆÙˆÙ…!</h1><h2>Ù„Ù‚Ø¯ Ù…Ø§Øª ${gameState.victimName}!</h2></div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem; color:#888">ÙƒÙ„ÙŠÙŠÙŠÙƒ...</h1><h2 style="color:#10b981">Ù„Ù‚Ø¯ Ù†Ø¬Ø§ ${gameState.victimName}!</h2></div>`;
                }
            }
            else if (gameState.status === 'winner') {
                overlay.style.display = 'flex';
                overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ†</h1><h2 style="color:#fcd34d">Ø§Ù„ÙØ§Ø¦Ø²: ${gameState.winner}</h2>${isHost ? '<button class="start-btn" onclick="triggerStart()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©)</button>' : ''}</div>`;
            }
        }
    </script>
</head>
<body>
    <div class="top-bar">
        <div class="room-pin" id="pinDisplay" onclick="copyPin()">----</div>
        <div class="turn-indicator" id="turnIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div class="target-box"><span>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span><div class="target-img-container" id="targetDisplay"></div></div>
    </div>
    <div class="arena" id="gameArena">
        <div class="table"><div class="discard-pile" id="discardPile"></div></div>
        <div id="playersRing" style="width:100%; height:100%; position:absolute;"></div>
    </div>
    <div class="bottom-area">
        <div class="spectator-mode" id="spectatorMode"><h2>ğŸ’€ Ø£Ù†Øª Ù…ÙŠØª</h2><p>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p></div>
        <div class="controls" id="controls">
            <button class="btn btn-play" id="btnPlay" disabled onclick="playAction()">â¬‡ï¸ Ø§Ù†Ø²Ù„</button>
            <button class="btn btn-liar" id="btnLiar" disabled onclick="liarAction()">ğŸ¤¥ ÙƒØ°Ø§Ø¨</button>
        </div>
        <div class="my-hand" id="myHand"></div>
    </div>
    <div class="overlay" id="overlay"><h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2></div>
    <div id="toast" class="toast">ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ âœ…</div>
</body>
</html>
