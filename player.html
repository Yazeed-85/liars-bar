<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #0f0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #2a0a0a 0%, #000 100%); touch-action: manipulation;}
        
        /* --- 1. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø¯ÙˆØ±) --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0,0,0,0.8); border-bottom: 2px solid #451a03; height: 90px; z-index: 20;}
        
        .target-box { display: flex; align-items: center; gap: 10px; background: #3f1808; padding: 5px 15px; border-radius: 15px; border: 1px solid #f59e0b;}
        .target-box span { font-weight: bold; color: #fcd34d; font-size: 1.1rem;}
        .target-img { width: 45px; border-radius: 4px; box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); animation: glowTarget 1.5s infinite alternate; border: 2px solid #fff;}
        @keyframes glowTarget { from { box-shadow: 0 0 5px #f59e0b; } to { box-shadow: 0 0 25px #f59e0b; transform: scale(1.05); } }

        .turn-indicator { flex: 1; text-align: center; font-size: 1.4rem; font-weight: bold; text-shadow: 0 2px 4px #000;}
        .turn-indicator .highlight { color: #f59e0b; font-size: 1.6rem; }
        .turn-indicator.my-turn .highlight { color: #10b981; }

        .room-pin { font-family: monospace; color: #888; font-size: 1.2rem; background: #111; padding: 5px 10px; border-radius: 8px;}

        /* --- 2. Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ³Ø·Ù‰ (Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†) --- */
        .arena { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;}
        
        /* Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…ØªØ¬Ø§ÙˆØ¨Ø© Ø§Ù„Ø­Ø¬Ù… (ØªØ£Ø®Ø° 60% Ù…Ù† Ø£ØµØºØ± Ø¨Ø¹Ø¯ Ù„Ù„Ø´Ø§Ø´Ø©) */
        .table { width: 65vmin; height: 65vmin; max-width: 450px; max-height: 450px; background: radial-gradient(circle, #065f46 0%, #022c22 100%); border-radius: 50%; border: 15px solid #451a03; box-shadow: inset 0 0 40px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.7); position: relative; display: flex; justify-content: center; align-items: center; z-index: 1;}
        
        .discard-pile { position: relative; width: 50px; height: 70px;}
        .thrown-card { position: absolute; width: 60px; border-radius: 4px; box-shadow: 2px 2px 8px rgba(0,0,0,0.6); border: 1px solid #ddd; top: 0; left: 0; transition: transform 0.1s;}

        /* Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© */
        .player-seat { position: absolute; width: 80px; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); z-index: 10;}
        .avatar { width: 55px; height: 55px; background: #1f2937; border-radius: 50%; border: 3px solid #4b5563; display: flex; justify-content: center; align-items: center; font-size: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s;}
        .p-name { background: rgba(0,0,0,0.9); padding: 3px 10px; border-radius: 12px; font-size: 0.85rem; margin-top: -10px; z-index: 2; border: 1px solid #333; white-space: nowrap; max-width: 100px; overflow: hidden; text-overflow: ellipsis; font-weight: bold;}
        .p-gun { font-size: 0.75rem; color: #ef4444; background: #111; padding: 2px 6px; border-radius: 4px; margin-top: 3px; font-weight: bold; border: 1px solid #333;}
        
        .active-turn .avatar { border-color: #f59e0b; box-shadow: 0 0 25px #f59e0b; transform: scale(1.2);}
        .active-turn .p-name { color: #f59e0b; border-color: #f59e0b;}
        .is-me .avatar { border-color: #3b82f6; background: #1e3a8a;}
        .dead { opacity: 0.3; filter: grayscale(100%); }

        /* Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© (Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†) */
        .flying-card-anim { position: absolute; width: 55px; border-radius: 4px; z-index: 100; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 10px 20px rgba(0,0,0,0.6);}

        /* --- 3. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ (Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚) --- */
        .bottom-area { background: #110808; border-top: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 20;}
        
        .controls { display: flex; gap: 15px; margin-bottom: 15px; width: 90%; max-width: 500px;}
        .btn { flex: 1; padding: 15px; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: linear-gradient(135deg, #2563eb, #1e3a8a); border-bottom: 4px solid #172554;}
        .btn-liar { background: linear-gradient(135deg, #dc2626, #7f1d1d); border-bottom: 4px solid #450a0a;}
        
        .my-hand { height: 120px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px;}
        .hand-card { width: 70px; margin-left: -30px; cursor: pointer; transition: 0.2s; position: relative;}
        .hand-card:first-child { margin-left: 0; }
        .hand-card img { width: 100%; border-radius: 5px; box-shadow: -3px 0 10px rgba(0,0,0,0.6);}
        .hand-card.selected { transform: translateY(-25px); z-index: 50;}
        .hand-card.selected img { outline: 3px solid #f59e0b; box-shadow: 0 10px 20px rgba(245,158,11,0.6);}

        /* --- 4. Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ (Ø§Ù„Ù„ÙˆØ¨ÙŠØŒ Ø§Ù„ÙƒØ´ÙØŒ Ø§Ù„Ù†ØªÙŠØ¬Ø©) --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5,5,5,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(8px);}
        .start-btn { padding: 15px 40px; font-size: 1.6rem; background: linear-gradient(#16a34a, #15803d); color: white; border: none; border-radius: 12px; cursor: pointer; border-bottom: 5px solid #14532d; margin-top: 20px;}
        
        .reveal-cards { display: flex; gap: 10px; margin: 20px 0;}
        .reveal-cards img { width: 90px; border-radius: 6px; box-shadow: 0 0 20px rgba(255,255,255,0.2);}
        .truth-glow img { box-shadow: 0 0 40px #10b981; border: 4px solid #10b981;}
        .liar-glow img { box-shadow: 0 0 40px #dc2626; border: 4px solid #dc2626;}

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØª Ø£Ùˆ Ø§Ù„Ù†Ø¬Ø§Ø© */
        .result-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 2px solid #333; box-shadow: 0 20px 50px #000; max-width: 90%;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');
        const isHost = urlParams.get('role') === 'host';

        const storageKey = `liars_v4_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) { myId = "p_" + Date.now(); localStorage.setItem(storageKey, myId); }

        const rootRef = `liars_rooms/${pin}`;
        const myPlayerRef = ref(db, `${rootRef}/players/${myId}`);
        const playersRef = ref(db, `${rootRef}/players`);
        const stateRef = ref(db, `${rootRef}/gameState`);
        const actionsRef = ref(db, `${rootRef}/actions`);
        const eventsRef = ref(db, `${rootRef}/events`);

        const CARD_IMGS = {
            'K': 'https://deckofcardsapi.com/static/img/KH.png', 'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png', 'A': 'https://deckofcardsapi.com/static/img/AS.png',
            '10': 'https://deckofcardsapi.com/static/img/0S.png', 'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        let gameState = { status: 'lobby', tableStack: [] };
        let players = {};
        let myHand = [];
        let selectedIndices = [];

        get(myPlayerRef).then((snap) => {
            if (!snap.exists()) {
                set(myPlayerRef, { name: myName, isAlive: true, hand: [], bulletIndex: Math.floor(Math.random() * 6), currentChamber: 0 });
            } else { if(snap.val().name) myName = snap.val().name; }
        });

        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            myHand = players[myId]?.hand || [];
            renderTable(); renderHand();
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || { status: 'lobby', tableStack: [] };
            renderUI(); renderPile();
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø±Ù…ÙŠ
        onChildAdded(eventsRef, (snap) => {
            const ev = snap.val();
            if (ev.type === 'throw' && (Date.now() - ev.time < 3000)) {
                animateThrow(ev.playerId, ev.count);
            }
        });

        // ----------------------------------------------------
        // Ø¹Ù‚Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ù„Ù‡ÙˆØ³Øª ÙÙ‚Ø·)
        // ----------------------------------------------------
        if (isHost) {
            window.hostStartGame = async function() {
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive);
                if (aliveIds.length < 2) return alert("Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");

                const numPlayers = aliveIds.length;
                let chosenSize = 6, jokersNeeded = 0, cardsPerType = 0, found = false;

                for (let size of [5, 6, 7, 8]) {
                    let totalCards = size * numPlayers;
                    for (let j = 0; j <= 2; j++) {
                        if ((totalCards - j) % 5 === 0) {
                            chosenSize = size; jokersNeeded = j; cardsPerType = (totalCards - j) / 5; found = true; break;
                        }
                    }
                    if (found) break;
                }

                let deck = [];
                ['K', 'Q', 'J', 'A', '10'].forEach(type => { for(let k=0; k < cardsPerType; k++) deck.push(type); });
                for(let k=0; k < jokersNeeded; k++) deck.push('Joker');
                deck.sort(() => Math.random() - 0.5);

                let updates = {};
                aliveIds.forEach(id => { updates[`players/${id}/hand`] = deck.splice(0, chosenSize); });

                const target = ['K', 'Q', 'J', 'A', '10'][Math.floor(Math.random() * 5)];
                const firstTurn = aliveIds[Math.floor(Math.random() * aliveIds.length)];

                updates[`gameState`] = { status: 'playing', targetCard: target, turnId: firstTurn, tableStack: [], lastPlay: null };
                await update(ref(db, rootRef), updates);
            };

            onChildAdded(actionsRef, async (snap) => {
                const action = snap.val();
                const key = snap.key;
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive).sort(); 
                
                try {
                    if (action.type === 'play') {
                        let stack = gameState.tableStack || [];
                        const visualCards = action.cards.map(() => ({ rot: Math.random()*60 - 30, x: Math.random()*30 - 15, y: Math.random()*30 - 15 }));
                        
                        // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹
                        const evRef = push(eventsRef, { type: 'throw', playerId: action.playerId, count: action.cards.length, time: Date.now() });
                        setTimeout(() => remove(evRef), 4000);

                        const currIdx = aliveIds.indexOf(action.playerId);
                        const nextId = aliveIds[(currIdx + 1) % aliveIds.length];

                        await update(stateRef, { tableStack: stack.concat(visualCards), turnId: nextId, lastPlay: { playerId: action.playerId, cards: action.cards } });
                    }
                    else if (action.type === 'liar') {
                        const lastMove = gameState.lastPlay;
                        let isLiar = false;
                        lastMove.cards.forEach(card => { if (card !== gameState.targetCard && card !== 'Joker') isLiar = true; });

                        let victimId = isLiar ? lastMove.playerId : action.playerId;
                        
                        await update(stateRef, {
                            status: 'reveal', revealedCards: lastMove.cards, isLiar: isLiar, victimId: victimId,
                            msg: isLiar ? `ÙƒØ´ÙÙ†Ø§Ù‡! ${players[lastMove.playerId].name} ÙƒØ°Ø§Ø¨!` : `Ù…Ø³ÙƒÙŠÙ†! ${players[lastMove.playerId].name} ÙƒØ§Ù† ØµØ§Ø¯Ù‚!`
                        });

                        setTimeout(() => update(stateRef, { status: 'roulette' }), 5000);
                    }
                    else if (action.type === 'shoot') {
                        const victim = players[action.playerId];
                        const died = victim.currentChamber === victim.bulletIndex;
                        
                        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø­Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù…Ø§Øª Ø£Ù… Ù†Ø¬Ø§) Ù„Ù„Ø¬Ù…ÙŠØ¹
                        await update(stateRef, { status: 'shot_result', died: died, victimName: victim.name });

                        if (died) {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { isAlive: false });
                            const survivors = aliveIds.filter(id => id !== action.playerId);
                            if (survivors.length === 1) {
                                setTimeout(() => update(stateRef, { status: 'winner', winner: players[survivors[0]].name }), 4000);
                            } else {
                                setTimeout(() => window.hostStartGame(), 4000);
                            }
                        } else {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { currentChamber: victim.currentChamber + 1 });
                            setTimeout(() => window.hostStartGame(), 4000);
                        }
                    }
                } catch(e) { console.error(e); }
                remove(ref(db, `${rootRef}/actions/${key}`));
            });
        }

        // ----------------------------------------------------
        // Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙˆØªÙØ§Ø¹Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„
        // ----------------------------------------------------
        
        function renderTable() {
            const container = document.getElementById('playersRing');
            container.innerHTML = '';
            
            const pKeys = Object.keys(players).sort();
            if (pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;
            const count = pKeys.length;
            
            pKeys.forEach((id, i) => {
                let relativeI = (i - myIndex + count) % count;
                let angle = (relativeI / count) * (2 * Math.PI) + (Math.PI / 2);
                
                // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹
                let rx = 45; let ry = 42;
                let left = 50 + (Math.cos(angle) * rx); 
                let top = 50 + (Math.sin(angle) * ry); 

                const p = players[id];
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isDead = !p.isAlive ? 'dead' : '';
                const isMe = id === myId ? 'is-me' : '';
                const gunInfo = p.isAlive ? `ğŸ”« ${p.currentChamber}/6` : 'ğŸ’€';

                const el = document.createElement('div');
                el.className = `player-seat ${isActive} ${isDead} ${isMe}`;
                el.id = `avatar-${id}`; // Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ù‡
                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.innerHTML = `
                    <div class="avatar"><span>ğŸ‘¤</span></div>
                    <div class="p-name">${id === myId ? '(Ø£Ù†Øª) '+p.name : p.name}</div>
                    <div class="p-gun">${gunInfo}</div>
                `;
                container.appendChild(el);
            });
        }

        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø·ÙŠØ±Ø§Ù† Ø§Ù„ÙˆØ±Ù‚Ø© Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØµÙ
        window.animateThrow = function(playerId, count) {
            const avatar = document.getElementById(`avatar-${playerId}`);
            const tableCenter = document.getElementById('discardPile');
            if(!avatar || !tableCenter) return;

            const startRect = avatar.getBoundingClientRect();
            const endRect = tableCenter.getBoundingClientRect();

            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const card = document.createElement('img');
                    card.src = CARD_IMGS['Back'];
                    card.className = 'flying-card-anim';
                    // Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† ÙˆØ¬Ù‡ Ø§Ù„Ù„Ø§Ø¹Ø¨
                    card.style.left = `${startRect.left + 10}px`;
                    card.style.top = `${startRect.top + 10}px`;
                    document.body.appendChild(card);

                    // ØªØ­Ø±ÙŠÙƒ Ù„Ù„ÙˆØ³Ø·
                    setTimeout(() => {
                        card.style.left = `${endRect.left + 10 + (Math.random()*20-10)}px`;
                        card.style.top = `${endRect.top + 10 + (Math.random()*20-10)}px`;
                        card.style.transform = `rotate(${Math.random()*90 - 45}deg) scale(0.9)`;
                    }, 50);

                    // Ø­Ø°ÙÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©
                    setTimeout(() => card.remove(), 500);
                }, i * 150);
            }
        }

        function renderPile() {
            const pile = document.getElementById('discardPile');
            const stack = gameState.tableStack || [];
            
            if (pile.childElementCount !== stack.length) {
                pile.innerHTML = '';
                stack.forEach((meta, i) => {
                    const card = document.createElement('div');
                    card.className = 'thrown-card';
                    // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„ÙˆØ±Ù‚Ø©
                    card.style.transform = `rotate(${meta.rot}deg) translate(${meta.x}px, ${meta.y}px)`;
                    card.style.zIndex = i;
                    pile.appendChild(card);
                });
            }
        }

        function renderHand() {
            const handDiv = document.getElementById('myHand');
            handDiv.innerHTML = '';
            if (!myHand) return;

            myHand.forEach((cardCode, i) => {
                const img = document.createElement('img');
                img.src = CARD_IMGS[cardCode] || CARD_IMGS['10']; 
                const div = document.createElement('div');
                div.className = `hand-card ${selectedIndices.includes(i) ? 'selected' : ''}`;
                div.onclick = () => toggleSelect(i);
                div.appendChild(img);
                handDiv.appendChild(div);
            });
        }

        window.toggleSelect = (i) => {
            if (gameState.status !== 'playing' || gameState.turnId !== myId) return;
            if (selectedIndices.includes(i)) selectedIndices = selectedIndices.filter(x => x !== i);
            else selectedIndices.push(i);
            renderHand(); updateBtns();
        };

        function updateBtns() {
            const btnPlay = document.getElementById('btnPlay');
            const btnLiar = document.getElementById('btnLiar');
            if (gameState.turnId === myId) {
                btnPlay.disabled = selectedIndices.length === 0;
                btnLiar.disabled = (gameState.tableStack || []).length === 0;
            } else {
                btnPlay.disabled = true; btnLiar.disabled = true;
            }
        }

        function renderUI() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
            if (gameState.targetCard) {
                document.getElementById('targetDisplay').innerHTML = `<img src="${CARD_IMGS[gameState.targetCard]}" class="target-img">`;
            }
            document.getElementById('pinDisplay').innerText = pin;

            const turnInd = document.getElementById('turnIndicator');
            if (gameState.status === 'playing') {
                if (gameState.turnId === myId) {
                    turnInd.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ÙŠØ§ <span class="highlight">${myName}</span>!`;
                    turnInd.className = 'turn-indicator my-turn';
                } else {
                    const tName = players[gameState.turnId] ? players[gameState.turnId].name : '...';
                    turnInd.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span class="highlight">${tName}</span>`;
                    turnInd.className = 'turn-indicator';
                }
            }

            const overlay = document.getElementById('overlay');
            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                if (isHost) {
                    overlay.innerHTML = `
                        <div class="result-box">
                            <h2 style="color:#aaa">Ø£Ø®Ø¨Ø± Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:</h2>
                            <h1 style="font-size:5rem; color:#dc2626; margin:10px 0; font-family:monospace">${pin}</h1>
                            <div style="color:#f59e0b">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${Object.keys(players).length}</div>
                            <button class="start-btn" onclick="triggerStart()">ğŸ² Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                        </div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h2>Ø£Ù‡Ù„Ø§Ù‹ ${myName}</h2><p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡ÙˆØ³Øª...</p></div>`;
                }
            }
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none'; updateBtns();
            }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                const glow = gameState.isLiar ? 'liar-glow' : 'truth-glow';
                const cardsHTML = (gameState.revealedCards || []).map(c => `<div class="${glow}"><img src="${CARD_IMGS[c]}"></div>`).join('');
                overlay.innerHTML = `
                    <div class="result-box">
                        <h1 style="color:${gameState.isLiar ? '#ef4444' : '#10b981'}; font-size:2.5rem;">${gameState.msg}</h1>
                        <div class="reveal-cards">${cardsHTML}</div>
                    </div>`;
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlay.innerHTML = `
                        <div class="result-box" style="border-color:#dc2626">
                            <h1 style="color:#ef4444; font-size:3rem">Ø¯ÙˆØ±Ùƒ ÙŠØ§ Ø¨Ø·Ù„!</h1>
                            <p style="margin:20px 0;">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯ ÙˆØ§Ø¯Ø¹Ù Ø£Ù† ØªÙ†Ø¬Ùˆ...</p>
                            <button class="start-btn" style="background:#dc2626; border-bottom-color:#991b1b;" onclick="triggerShoot()">ğŸ”« Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø±</button>
                        </div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem">ğŸ”«</h1><h2>${players[gameState.victimId]?.name} ÙŠØ·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±...</h2></div>`;
                }
            }
            else if (gameState.status === 'shot_result') {
                // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ù„Ù‚Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
                overlay.style.display = 'flex';
                if (gameState.died) {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ’¥</h1><h1 style="color:#ef4444">Ø¨Ù€Ù€Ù€ÙˆÙˆÙˆÙ…!</h1><h2>Ù„Ù‚Ø¯ Ù…Ø§Øª ${gameState.victimName}!</h2></div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem; color:#aaa">ÙƒÙ„ÙŠÙŠÙŠÙƒ...</h1><h2 style="color:#10b981">Ù„Ù‚Ø¯ Ù†Ø¬Ø§ ${gameState.victimName}!</h2></div>`;
                }
            }
            else if (gameState.status === 'winner') {
                overlay.style.display = 'flex';
                overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ†</h1><h2 style="color:#fcd34d">Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${gameState.winner}</h2>${isHost ? '<button class="start-btn" onclick="triggerStart()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>' : ''}</div>`;
            }
        }

        window.triggerStart = () => { if(isHost) window.hostStartGame(); };
        
        window.playAction = () => {
            const cards = selectedIndices.map(i => myHand[i]);
            push(actionsRef, { type: 'play', playerId: myId, cards: cards });
            myHand = myHand.filter((_, i) => !selectedIndices.includes(i));
            selectedIndices = [];
            renderHand(); document.getElementById('btnPlay').disabled = true;
        };

        window.liarAction = () => {
            if(confirm("Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ§Ø¯Ù‚Ø§Ù‹ Ø³ØªÙ…ÙˆØª Ø£Ù†Øª! Ù…ØªØ£ÙƒØ¯ØŸ")) push(actionsRef, { type: 'liar', playerId: myId });
        };

        window.triggerShoot = () => {
            push(actionsRef, { type: 'shoot', playerId: myId });
            document.getElementById('overlay').innerHTML = `<h2>...</h2>`;
        };

    </script>
</head>
<body>

    <div class="top-bar">
        <div class="room-pin" id="pinDisplay">----</div>
        <div class="turn-indicator" id="turnIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div class="target-box">
            <span>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
            <div id="targetDisplay"><div class="target-img" style="background:#fff; width:30px; height:45px;"></div></div>
        </div>
    </div>

    <div class="arena" id="gameArena">
        <div class="table">
            <div class="discard-pile" id="discardPile"></div>
        </div>
        <div id="playersRing" style="width:100%; height:100%; position:absolute;"></div>
    </div>

    <div class="bottom-area">
        <div class="controls">
            <button class="btn btn-play" id="btnPlay" disabled onclick="playAction()">â¬‡ï¸ Ø§Ù†Ø²Ù„</button>
            <button class="btn btn-liar" id="btnLiar" disabled onclick="liarAction()">ğŸ¤¥ ÙƒØ°Ø§Ø¨</button>
        </div>
        <div class="my-hand" id="myHand"></div>
    </div>

    <div class="overlay" id="overlay">
        <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
    </div>

</body>
</html>
