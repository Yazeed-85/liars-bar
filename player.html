<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #0a0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #2a1010 0%, #000 100%); touch-action: manipulation;}
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¯ÙˆØ± */
        .turn-banner { width: 100%; background: rgba(0,0,0,0.8); padding: 10px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid #dc2626; z-index: 10;}
        .turn-banner span { color: #f59e0b; font-size: 1.4rem; }

        /* Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø¹Ø¨ ÙˆØ§Ù„Ø·Ø§ÙˆÙ„Ø© (Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡ÙˆØ³Øª ØªÙ…Ø§Ù…Ø§Ù‹) */
        .game-arena { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden;}
        
        .table-center { position: absolute; width: 260px; height: 180px; background: #064e3b; border-radius: 20px; border: 10px solid #451a03; box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1;}
        
        /* Ø§Ù„Ø£ÙØ§ØªØ§Ø± ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-seat { position: absolute; display: flex; flex-direction: column; align-items: center; width: 80px; transform: translate(-50%, -50%); z-index: 5; transition: all 0.5s ease;}
        .avatar { width: 50px; height: 50px; background: #1a1a1a; border-radius: 50%; border: 3px solid #555; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative;}
        .avatar svg { width: 25px; height: 25px; fill: #aaa; }
        .p-name { font-weight: bold; background: rgba(0,0,0,0.9); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-top: -8px; z-index: 2; border: 1px solid #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;}
        .p-gun { font-size: 0.75rem; color: #f59e0b; margin-top: 2px; font-weight: bold;}
        
        /* ØªÙ…ÙŠÙŠØ² Ù…ÙƒØ§Ù†ÙŠ Ø£Ù†Ø§ (Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚) */
        .is-me .avatar { border-color: #3b82f6; background: #1e3a8a;}
        
        .dead .avatar { border-color: #dc2626; opacity: 0.4;}
        .dead .p-name { text-decoration: line-through; color: #888;}
        .active-turn .avatar { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); animation: pulseAvatar 1s infinite;}
        @keyframes pulseAvatar { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .target-card-img { width: 50px; border-radius: 5px; box-shadow: 0 0 15px rgba(255,255,255,0.3); border: 2px solid #fff;}
        .flying-card { position: absolute; width: 40px; border-radius: 3px; z-index: 100; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 5px 10px rgba(0,0,0,0.5);}
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (ÙŠØ¯ÙŠ) */
        .my-hand-area { width: 100%; height: 130px; background: #110808; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 15px; border-top: 2px solid #333; z-index: 10;}
        .real-card { width: 65px; border-radius: 5px; box-shadow: -5px 0 15px rgba(0,0,0,0.8); cursor: pointer; transition: all 0.2s ease-out; margin-left: -30px; position: relative;}
        .real-card:first-child { margin-left: 0; }
        .real-card.selected { transform: translateY(-20px); outline: 3px solid #f59e0b; z-index: 50; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.6);}

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { display: flex; gap: 10px; padding: 15px; background: #000; border-top: 1px solid #222; z-index: 10;}
        .btn { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; color: white; transition: 0.1s;}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: #2563eb; }
        .btn-liar { background: #dc2626; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´Ù ÙˆØ§Ù„Ø±ÙˆÙ„ÙŠØª Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ */
        .overlay-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;}
        .btn-shoot { background: transparent; border: 3px solid #dc2626; color: #dc2626; padding: 20px 40px; font-size: 2rem; border-radius: 15px; margin-top: 30px; font-weight: bold; cursor: pointer;}
        .btn-shoot:active { background: #dc2626; color: white; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† ÙˆÙ‚ÙˆÙŠ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        const storageKey = `liars_bar_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        
        if (!myId) {
            myId = "player_" + Date.now();
            localStorage.setItem(storageKey, myId);
            set(ref(db, `liars_rooms/${pin}/players/${myId}`), { name: myName, isAlive: true, hand: [], currentChamber: 0, bulletIndex: Math.floor(Math.random() * 6) });
        } else {
            get(ref(db, `liars_rooms/${pin}/players/${myId}`)).then((snap) => {
                if(!snap.exists()) {
                    set(ref(db, `liars_rooms/${pin}/players/${myId}`), { name: myName, isAlive: true, hand: [], currentChamber: 0, bulletIndex: Math.floor(Math.random() * 6) });
                } else {
                    myName = snap.val().name;
                }
            });
        }

        const myRef = ref(db, `liars_rooms/${pin}/players/${myId}`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`);
        const eventsRef = ref(db, `liars_rooms/${pin}/events`);

        const CARD_IMAGES = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png', 'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png', 'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        let gameState = {};
        let allPlayers = {};
        let myData = {};
        let selectedCards = [];

        onValue(playersRef, (snap) => {
            if(snap.exists()) {
                allPlayers = snap.val();
                myData = allPlayers[myId] || {};
                renderArena();
                renderHand();
                updateUI();
            }
        });

        onValue(stateRef, (snap) => {
            if(snap.exists()) {
                gameState = snap.val();
                renderArena();
                updateUI();
            }
        });

        onChildAdded(eventsRef, (snap) => {
            const ev = snap.val();
            if (ev.type === 'throw') animateCardThrow(ev.playerId, ev.count);
        });

        // Ø±Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§Ø¦Ø±ÙŠØ©ØŒ Ù…Ø¹ Ø¬Ø¹Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
        window.renderArena = function() {
            const ring = document.getElementById('playersRing');
            ring.innerHTML = '';
            const pKeys = Object.keys(allPlayers);
            if(pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;

            const total = pKeys.length;
            
            pKeys.forEach((id, i) => {
                const p = allPlayers[id];
                const isDead = p.isAlive === false ? 'dead' : '';
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isMe = id === myId ? 'is-me' : '';
                const chambers = p.currentChamber !== undefined ? p.currentChamber : 0;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ ØªÙ…Ø§Ù…Ø§Ù‹ (90 Ø¯Ø±Ø¬Ø© = Math.PI / 2)
                let relativeIndex = (i - myIndex + total) % total;
                const angle = (relativeIndex / total) * (2 * Math.PI) + (Math.PI / 2);
                
                // Ø£Ø¨Ø¹Ø§Ø¯ Ø¨ÙŠØ¶Ø§ÙˆÙŠØ© Ù„ØªÙ†Ø§Ø³Ø¨ Ø´Ø§Ø´Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø·ÙˆÙ„ÙŠØ©
                const radiusX = 40; 
                const radiusY = 35; 
                const left = 50 + radiusX * Math.cos(angle);
                const top = 45 + radiusY * Math.sin(angle); // 45 Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙƒØ² Ù‚Ù„ÙŠÙ„Ø§Ù‹

                let nameDisplay = id === myId ? '(Ø£Ù†Øª)' : p.name;

                ring.innerHTML += `
                    <div class="player-seat ${isActive} ${isDead} ${isMe}" id="seat-${id}" style="left: ${left}%; top: ${top}%;">
                        <div class="avatar"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                        <div class="p-name">${nameDisplay}</div>
                        <div class="p-gun">ğŸ”« ${chambers}/6</div>
                    </div>
                `;
            });
        }

        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø±Ù…ÙŠ Ø§Ù„ÙˆØ±Ù‚ Ø§Ù„Ù…ØµØºØ± Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function animateCardThrow(playerId, count) {
            const seat = document.getElementById(`seat-${playerId}`);
            const table = document.getElementById('tableCenter');
            if(!seat || !table) return;

            const seatRect = seat.getBoundingClientRect();
            const tableRect = table.getBoundingClientRect();

            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const card = document.createElement('img');
                    card.src = CARD_IMAGES['Back'];
                    card.className = 'flying-card';
                    card.style.left = `${seatRect.left + 20}px`;
                    card.style.top = `${seatRect.top + 20}px`;
                    document.body.appendChild(card);

                    setTimeout(() => {
                        card.style.left = `${tableRect.left + (tableRect.width/2) - 20 + (Math.random()*20 - 10)}px`;
                        card.style.top = `${tableRect.top + (tableRect.height/2) - 20 + (Math.random()*20 - 10)}px`;
                        card.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
                    }, 50);

                    setTimeout(() => card.remove(), 500);
                }, i * 150); 
            }
        }

        function renderHand() {
            const area = document.getElementById('myHandArea');
            area.innerHTML = '';
            if (!myData.hand) return;

            myData.hand.forEach((card, index) => {
                const isSel = selectedCards.includes(index) ? 'selected' : '';
                area.innerHTML += `<img src="${CARD_IMAGES[card]}" id="card-${index}" class="real-card ${isSel}" style="z-index: ${index};" onclick="toggleCard(${index})">`;
            });
        }

        window.toggleCard = function(index) {
            if (gameState.turnId !== myId || gameState.status !== 'playing') return;
            if (selectedCards.includes(index)) selectedCards = selectedCards.filter(i => i !== index);
            else selectedCards.push(index);
            renderHand(); updateUI();
        };

        window.playCards = function() {
            if (selectedCards.length === 0) return;
            const cardsToPlay = selectedCards.map(i => myData.hand[i]);
            const newHand = myData.hand.filter((_, i) => !selectedCards.includes(i));
            push(actionsRef, { type: 'play', playerId: myId, cards: cardsToPlay });
            set(ref(db, `liars_rooms/${pin}/players/${myId}/hand`), newHand);
            selectedCards = [];
        };

        window.callLiar = function() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙƒØ°ÙŠØ¨Ù‡ØŸ Ø§Ù„Ø±ØµØ§ØµØ© Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ Ø¥Ù† ÙƒØ§Ù† ØµØ§Ø¯Ù‚Ø§Ù‹!")) {
                push(actionsRef, { type: 'call_liar', playerId: myId });
            }
        };

        window.shoot = function() {
            document.getElementById('shootBtn').style.display = 'none'; 
            push(actionsRef, { type: 'shoot', playerId: myId });
        };

        function updateUI() {
            const turnBanner = document.getElementById('turnBanner');
            const playBtn = document.getElementById('playBtn');
            const liarBtn = document.getElementById('liarBtn');
            const overlay = document.getElementById('overlayScreen');
            const overlayText = document.getElementById('overlayText');
            const shootBtn = document.getElementById('shootBtn');
            const tableCenter = document.getElementById('tableCenter');

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯
            if (!gameState || !gameState.status) {
                turnBanner.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©...";
                return;
            }

            if (!myData.isAlive) {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h1 style='color:#ef4444; font-size:4rem;'>ğŸ’€</h1><h2>Ù„Ù‚Ø¯ Ù…Øª!</h2><p style='color:#aaa;'>Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ§Ù†ØªØ¸Ø± Ø§Ù„Ù†Ù‡Ø§ÙŠØ©...</p>";
                shootBtn.style.display = 'none'; return;
            }

            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex'; 
                overlayText.innerHTML = "<h2>ğŸ» Ø­Ø§Ù†Ø© Ø§Ù„ÙƒØ°Ø§Ø¨ÙŠÙ†</h2><p style='color:#aaa;'>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù‡ÙˆØ³Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>"; 
                shootBtn.style.display = 'none';
                tableCenter.style.display = 'none';
            } 
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                tableCenter.style.display = 'flex';
                
                const stackCount = (gameState.tableStack || []).length;
                tableCenter.innerHTML = `
                    <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 5px;">Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
                    <img src="${CARD_IMAGES[gameState.targetCard]}" class="target-card-img">
                    <div style="color: #fcd34d; font-weight: bold; margin-top:5px; font-size:0.9rem;">Ø£ÙˆØ±Ø§Ù‚ Ù…Ù‚Ù„ÙˆØ¨Ø©: ${stackCount}</div>
                `;

                if (gameState.turnId === myId) {
                    turnBanner.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†! Ø§Ù†Ø²Ù„ ÙˆØ±Ù‚Ø© Ø£Ùˆ Ø§Ø¶ØºØ· ÙƒØ§Ø°Ø¨`;
                    turnBanner.style.borderBottomColor = '#10b981';
                    playBtn.disabled = selectedCards.length === 0;
                    liarBtn.disabled = stackCount === 0; 
                } else {
                    const actName = allPlayers[gameState.turnId] ? allPlayers[gameState.turnId].name : '...';
                    turnBanner.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span>${actName}</span>`;
                    turnBanner.style.borderBottomColor = '#333';
                    playBtn.disabled = true; liarBtn.disabled = true;
                }
            }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = `<h2>ğŸ‘€ Ø§Ù†Ø¸Ø± Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù‡ÙˆØ³Øª!</h2><p style='color:#aaa;'>ÙŠØªÙ… ÙƒØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù†...</p>`;
                shootBtn.style.display = 'none';
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlayText.innerHTML = "<h1 style='color:#ef4444;'>ğŸš¨ Ø£Ù†Øª Ø§Ù„Ø¶Ø­ÙŠØ©!</h1><p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</p>";
                    shootBtn.style.display = 'block';
                } else {
                    overlayText.innerHTML = `<h2>ğŸ˜± Ø±ÙˆÙ„ÙŠØª Ø§Ù„Ù…ÙˆØª</h2><p style='color:#aaa;'>${gameState.victimName} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³ Ø§Ù„Ø¢Ù†...</p>`;
                    shootBtn.style.display = 'none';
                }
            }
            else if (gameState.status === 'game_over') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = `<h1 style='font-size:4rem;'>ğŸ†</h1><h2 style='color:#fcd34d;'>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2><p>Ø§Ù„Ù†Ø§Ø¬ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±: ${gameState.winnerName}</p>`;
                shootBtn.style.display = 'none';
            }
        }
    </script>
</head>
<body>

    <div class="turn-banner" id="turnBanner">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <div class="game-arena" id="gameArena">
        <div class="table-center" id="tableCenter" style="display:none;"></div>
        <div id="playersRing"></div>
    </div>

    <div class="my-hand-area" id="myHandArea"></div>

    <div class="controls">
        <button class="btn btn-play" id="playBtn" disabled onclick="playCards()">â¬‡ï¸ Ø§Ù†Ø²Ù„ Ø§Ù„ÙˆØ±Ù‚</button>
        <button class="btn btn-liar" id="liarBtn" disabled onclick="callLiar()">ğŸ¤¥ ÙƒØ§Ø§Ø§Ø°Ø¨!</button>
    </div>

    <div class="overlay-screen" id="overlayScreen">
        <div id="overlayText"></div>
        <button class="btn-shoot" id="shootBtn" onclick="shoot()">ğŸ”« Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</button>
    </div>

</body>
</html>
