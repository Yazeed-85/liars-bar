<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: #110808; color: white; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; touch-action: manipulation;}
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø±Ø¤ÙŠØ© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©) */
        .players-bar { width: 100%; display: flex; overflow-x: auto; background: #1a0a0a; padding: 10px; border-bottom: 2px solid #3a1a1a; gap: 10px; align-items: center; white-space: nowrap;}
        .p-badge { background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; text-align: center; min-width: 100px;}
        .p-badge.active { border-color: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.5);}
        .p-badge.dead { opacity: 0.3; text-decoration: line-through;}
        .turn-role { font-size: 0.8rem; color: #f59e0b; font-weight: bold; margin-bottom: 3px;}

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø§Ù„Ù…ØµØºØ±Ø© */
        .mini-table { width: 100%; flex: 1; background: #064e3b; border-bottom: 5px solid #451a03; border-top: 5px solid #451a03; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 0 30px rgba(0,0,0,0.8); position: relative; padding: 10px;}
        .target-card-img { width: 80px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-radius: 5px; margin: 10px;}
        .table-info { text-align: center; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; margin-bottom: 10px;}

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (ÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨) */
        .hand-area { width: 100%; height: 180px; background: #1a0a0a; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; position: relative;}
        
        .real-card { width: 75px; position: absolute; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; box-shadow: -2px 0 10px rgba(0,0,0,0.7); border-radius: 4px; bottom: 10px;}
        .real-card:active { transform: translateY(-10px); }
        .real-card.selected { transform: translateY(-30px); outline: 3px solid #f59e0b; z-index: 100 !important; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.6);}

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { width: 100%; display: flex; gap: 10px; padding: 15px; background: #000; border-top: 1px solid #333;}
        .btn { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; color: white; transition: 0.1s;}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%);}
        
        .btn-play { background: #2563eb; }
        .btn-liar { background: #dc2626; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØª ÙˆØ§Ù„Ø±ÙˆÙ„ÙŠØª */
        .overlay-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;}
        .btn-shoot { background: transparent; border: 3px solid #dc2626; color: #dc2626; padding: 20px 40px; font-size: 2rem; border-radius: 15px; margin-top: 30px; font-weight: bold;}
        .btn-shoot:active { background: #dc2626; color: white; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        const myName = urlParams.get('name');
        const myId = "player_" + Date.now();

        const myRef = ref(db, `liars_rooms/${pin}/players/${myId}`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`);

        // ØµÙˆØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©
        const CARD_IMAGES = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png',
            'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        set(myRef, { name: myName, isAlive: true, hand: [] });
        onDisconnect(myRef).remove();

        let gameState = {};
        let allPlayers = {};
        let myData = {};
        let selectedCards = [];

        onValue(playersRef, (snap) => {
            if(snap.exists()) {
                allPlayers = snap.val();
                myData = allPlayers[myId] || {};
                renderTopBar();
                renderHand();
                updateUI();
            }
        });

        onValue(stateRef, (snap) => {
            if(snap.exists()) {
                gameState = snap.val();
                renderTopBar();
                updateUI();
            }
        });

        // Ø±Ø³Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ø³Ø¯Ø³Ø§Øª
        function renderTopBar() {
            const bar = document.getElementById('playersBar');
            bar.innerHTML = '';
            
            const aliveKeys = Object.keys(allPlayers).filter(k => allPlayers[k].isAlive);
            const currIdx = aliveKeys.indexOf(gameState.turnId);
            const myIdx = aliveKeys.indexOf(myId);

            Object.keys(allPlayers).forEach(id => {
                const p = allPlayers[id];
                const isDead = p.isAlive === false ? 'dead' : '';
                const isActive = gameState.turnId === id ? 'active' : '';
                const chambers = p.currentChamber !== undefined ? p.currentChamber : 0;
                
                let roleText = "";
                if (gameState.status === 'playing') {
                    if (id === gameState.turnId) roleText = "ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø¢Ù†";
                    else if (p.isAlive) {
                        const targetIdx = aliveKeys.indexOf(id);
                        if (targetIdx === (currIdx + 1) % aliveKeys.length) roleText = "Ø§Ù„ØªØ§Ù„ÙŠ";
                        if (targetIdx === (currIdx - 1 + aliveKeys.length) % aliveKeys.length) roleText = "Ø§Ù„Ø³Ø§Ø¨Ù‚";
                    }
                }

                bar.innerHTML += `
                    <div class="p-badge ${isActive} ${isDead}">
                        <div class="turn-role">${roleText}</div>
                        <div>${id === myId ? '(Ø£Ù†Øª) ' + p.name : p.name}</div>
                        <div style="font-size: 0.8rem; color:#888;">ğŸ”« ${chambers}/6</div>
                    </div>
                `;
            });
        }

        // Ø±Ø³Ù… Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…ØªØ¯Ø§Ø®Ù„ (Fan shape)
        function renderHand() {
            const area = document.getElementById('handArea');
            area.innerHTML = '';
            if (!myData.hand) return;

            const total = myData.hand.length;
            const offset = 40; // Ù…Ø³Ø§ÙØ© Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ø¨ÙŠÙ† ÙƒÙ„ ÙˆØ±Ù‚Ø©

            myData.hand.forEach((card, index) => {
                const isSel = selectedCards.includes(index) ? 'selected' : '';
                const imgSrc = CARD_IMAGES[card];
                
                // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙˆØ±Ù‚Ø© Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ Ù…ØªØ¯Ø§Ø®Ù„Ø©
                const startLeft = `calc(50% - ${(total * offset)/2}px + ${index * offset}px)`;

                area.innerHTML += `
                    <img src="${imgSrc}" 
                         id="card-${index}" 
                         class="real-card ${isSel}" 
                         style="left: ${startLeft}; z-index: ${index};"
                         onclick="toggleCard(${index})">
                `;
            });
        }

        window.toggleCard = function(index) {
            if (gameState.turnId !== myId || gameState.status !== 'playing') return;
            
            if (selectedCards.includes(index)) {
                selectedCards = selectedCards.filter(i => i !== index);
            } else {
                selectedCards.push(index);
            }
            renderHand(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ CSS
            updateUI();
        };

        window.playCards = function() {
            if (selectedCards.length === 0) return;
            const cardsToPlay = selectedCards.map(i => myData.hand[i]);
            const newHand = myData.hand.filter((_, i) => !selectedCards.includes(i));
            
            push(actionsRef, { type: 'play', playerId: myId, cards: cardsToPlay });
            set(ref(db, `liars_rooms/${pin}/players/${myId}/hand`), newHand);
            selectedCards = [];
        };

        window.callLiar = function() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„Ùƒ ØµØ§Ø¯Ù‚Ø§Ù‹ØŒ Ø³ØªÙ…Ø³Ùƒ Ø£Ù†Øª Ø§Ù„Ù…Ø³Ø¯Ø³!")) {
                push(actionsRef, { type: 'call_liar', playerId: myId });
            }
        };

        window.shoot = function() {
            document.getElementById('shootBtn').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
            push(actionsRef, { type: 'shoot', playerId: myId });
        };

        function updateUI() {
            const tableContent = document.getElementById('tableContent');
            const playBtn = document.getElementById('playBtn');
            const liarBtn = document.getElementById('liarBtn');
            const overlay = document.getElementById('overlayScreen');
            const overlayText = document.getElementById('overlayText');
            const shootBtn = document.getElementById('shootBtn');

            if (!myData.isAlive) {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h1 style='color:#ef4444; font-size:4rem;'>ğŸ’€</h1><h2>Ù„Ù‚Ø¯ Ù…Øª!</h2><p>Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¨Ù‚ÙŠØ© ÙˆÙ‡Ù… ÙŠØªØ³Ø§Ù‚Ø·ÙˆÙ†...</p>";
                shootBtn.style.display = 'none';
                return;
            }

            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h2>ğŸ» Ø­Ø§Ù†Ø© Ø§Ù„ÙƒØ°Ø§Ø¨ÙŠÙ†</h2><p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡ÙˆØ³Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>";
                shootBtn.style.display = 'none';
            } 
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø©
                const stackCount = (gameState.tableStack || []).length;
                tableContent.innerHTML = `
                    <div class="table-info">Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¹Ø¨:</div>
                    <img src="${CARD_IMAGES[gameState.targetCard]}" class="target-card-img">
                    <div style="color: #fcd34d; font-weight: bold; font-size:1.1rem;">Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: ${stackCount}</div>
                `;

                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±ÙŠ
                if (gameState.turnId === myId) {
                    playBtn.disabled = selectedCards.length === 0;
                    liarBtn.disabled = stackCount === 0; // Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒØ°ÙŠØ¨ Ø´Ø®Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙØ§Ø±ØºØ©
                    document.body.style.boxShadow = "inset 0 0 30px rgba(16, 185, 129, 0.5)"; // Ø¥Ø¶Ø§Ø¡Ø© Ø®Ø¶Ø±Ø§Ø¡ Ù„Ø¯ÙˆØ±ÙŠ
                } else {
                    playBtn.disabled = true; 
                    liarBtn.disabled = true;
                    document.body.style.boxShadow = "none";
                }
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlayText.innerHTML = "<h1 style='color:#ef4444;'>ğŸš¨ Ø£Ù†Øª Ø§Ù„Ø¶Ø­ÙŠØ©!</h1><p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯ ÙˆØ§Ø¯Ø¹Ù Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±ØºØ§Ù‹...</p>";
                    shootBtn.style.display = 'block';
                } else {
                    overlayText.innerHTML = `<h2>ğŸ˜± Ø±ÙˆÙ„ÙŠØª Ø§Ù„Ù…ÙˆØª</h2><p>${gameState.victimName} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³ Ø§Ù„Ø¢Ù†...</p>`;
                    shootBtn.style.display = 'none';
                }
            }
            else if (gameState.status === 'game_over') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = `<h1>ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h1><h2>Ø§Ù„Ù†Ø§Ø¬ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±: ${gameState.winnerName}</h2>`;
                shootBtn.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    
    <div class="players-bar" id="playersBar"></div>

    <div class="mini-table">
        <div id="tableContent" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø§ÙˆÙ„Ø©...</div>
    </div>

    <div class="hand-area" id="handArea"></div>

    <div class="controls">
        <button class="btn btn-play" id="playBtn" disabled onclick="playCards()">â¬‡ï¸ Ø§Ù†Ø²Ù„ Ø§Ù„ÙˆØ±Ù‚</button>
        <button class="btn btn-liar" id="liarBtn" disabled onclick="callLiar()">ğŸ¤¥ ÙƒØ§Ø§Ø§Ø°Ø¨!</button>
    </div>

    <div class="overlay-screen" id="overlayScreen">
        <div id="overlayText"></div>
        <button class="btn-shoot" id="shootBtn" onclick="shoot()">ğŸ”« Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</button>
    </div>

</body>
</html>
