<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: #0a0505; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; touch-action: manipulation; background-image: radial-gradient(circle at top, #1a0a0a 0%, #000 100%);}
        
        .turn-banner { width: 100%; background: #000; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid #333; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.8);}
        .turn-banner span { color: #f59e0b; font-size: 1.4rem; }

        /* Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ù„Ù„Ø§Ø¹Ø¨ */
        .arena-container { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; border-bottom: 4px solid #333;}
        .table-mini { position: absolute; width: 220px; height: 160px; background: #064e3b; border-radius: 15px; border: 8px solid #451a03; box-shadow: inset 0 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1;}
        
        .player-seat { position: absolute; display: flex; flex-direction: column; align-items: center; width: 70px; transform: translate(-50%, -50%); z-index: 5; transition: all 0.5s;}
        .avatar { width: 45px; height: 45px; background: #1a1a1a; border-radius: 50%; border: 2px solid #555; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 10px rgba(0,0,0,0.5);}
        .avatar svg { width: 25px; height: 25px; fill: #aaa; }
        .p-name { font-weight: bold; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; margin-top: -8px; z-index: 2; border: 1px solid #333; white-space: nowrap;}
        
        /* ØªÙ„ÙˆÙŠÙ† Ø£ÙØ§ØªØ§Ø±ÙŠ Ø£Ù†Ø§ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„ØªÙ…ÙŠÙŠØ² Ù…ÙƒØ§Ù†ÙŠ */
        .is-me .avatar { border-color: #3b82f6; background: #1e3a8a;}
        
        .dead .avatar { border-color: #dc2626; opacity: 0.4;}
        .active-turn .avatar { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); animation: pulseAvatar 1s infinite;}
        
        .target-card-img { width: 45px; border-radius: 4px; box-shadow: 0 0 15px rgba(252, 211, 77, 0.8); border: 2px solid #fcd34d;}
        .flying-card { position: absolute; width: 35px; border-radius: 3px; z-index: 100; transition: all 0.5s ease-out; box-shadow: 0 5px 10px rgba(0,0,0,0.5);}

        /* Ø£ÙˆØ±Ø§Ù‚ ÙŠØ¯ÙŠ */
        .my-hand-area { background: #110808; padding: 20px 10px; display: flex; justify-content: center; height: 150px; align-items: flex-end;}
        .real-card { width: 70px; border-radius: 5px; box-shadow: -5px 0 15px rgba(0,0,0,0.8); cursor: pointer; transition: all 0.2s ease-out; margin-left: -35px; position: relative;}
        .real-card:first-child { margin-left: 0; } 
        .real-card.selected { transform: translateY(-25px); outline: 3px solid #f59e0b; z-index: 50; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.6);}

        /* Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { display: flex; gap: 10px; padding: 15px; background: #000; border-top: 1px solid #333; z-index: 10;}
        .btn { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; color: white; transition: 0.1s;}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: #2563eb; }
        .btn-liar { background: #dc2626; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø§ÙƒØ¨ */
        .overlay-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;}
        .btn-shoot { background: transparent; border: 3px solid #dc2626; color: #dc2626; padding: 20px 40px; font-size: 2rem; border-radius: 15px; margin-top: 30px; font-weight: bold; cursor: pointer;}
        .btn-shoot:active { background: #dc2626; color: white; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');

        const storageKey = `liars_bar_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) {
            myId = "player_" + Date.now();
            localStorage.setItem(storageKey, myId);
            set(ref(db, `liars_rooms/${pin}/players/${myId}`), { name: myName, isAlive: true, hand: [] });
        } else {
            get(ref(db, `liars_rooms/${pin}/players/${myId}/name`)).then((snap) => { if(snap.exists()) myName = snap.val(); });
        }

        const myRef = ref(db, `liars_rooms/${pin}/players/${myId}`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`);
        const eventsRef = ref(db, `liars_rooms/${pin}/events`);

        const CARD_IMAGES = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png', 'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png', 'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        let gameState = {};
        let allPlayers = {};
        let myData = {};
        let selectedCards = [];

        onValue(playersRef, (snap) => {
            if(snap.exists()) {
                allPlayers = snap.val();
                myData = allPlayers[myId] || {};
                renderArena();
                renderHand();
                updateUI();
            }
        });

        onValue(stateRef, (snap) => {
            if(snap.exists()) {
                gameState = snap.val();
                renderArena();
                updateUI();
            }
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙŠØ¶Ø§Ù‹
        onChildAdded(eventsRef, (snap) => {
            const ev = snap.val();
            if (ev.type === 'throw') animateCardThrow(ev.playerId, ev.count);
        });

        // Ø±Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§Ø¦Ø±ÙŠØ©ØŒ Ù…Ø¹ Ø¬Ø¹Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Ø²Ø§ÙˆÙŠØ© 90 Ø¯Ø±Ø¬Ø©)
        window.renderArena = function() {
            const ring = document.getElementById('playersRing');
            ring.innerHTML = '';
            const pKeys = Object.keys(allPlayers);
            if(pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;

            const total = pKeys.length;
            
            pKeys.forEach((id, i) => {
                const p = allPlayers[id];
                const isDead = p.isAlive === false ? 'dead' : '';
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isMe = id === myId ? 'is-me' : '';
                
                // Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Math.PI / 2)
                let relativeIndex = (i - myIndex + total) % total;
                const angle = (relativeIndex / total) * (2 * Math.PI) + (Math.PI / 2);
                
                const radiusX = 40; 
                const radiusY = 38; 
                const left = 50 + radiusX * Math.cos(angle);
                const top = 50 + radiusY * Math.sin(angle);

                ring.innerHTML += `
                    <div class="player-seat ${isActive} ${isDead} ${isMe}" id="p-seat-${id}" style="left: ${left}%; top: ${top}%;">
                        <div class="avatar"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                        <div class="p-name">${p.name}</div>
                    </div>
                `;
            });
        }

        function animateCardThrow(playerId, count) {
            const seat = document.getElementById(`p-seat-${playerId}`);
            const table = document.getElementById('tableMini');
            if(!seat || !table) return;

            const seatRect = seat.getBoundingClientRect();
            const tableRect = table.getBoundingClientRect();

            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const card = document.createElement('img');
                    card.src = CARD_IMAGES['Back'];
                    card.className = 'flying-card';
                    card.style.left = `${seatRect.left + 15}px`;
                    card.style.top = `${seatRect.top + 15}px`;
                    document.body.appendChild(card);

                    setTimeout(() => {
                        card.style.left = `${tableRect.left + (tableRect.width/2) - 15 + (Math.random()*20 - 10)}px`;
                        card.style.top = `${tableRect.top + (tableRect.height/2) - 20 + (Math.random()*20 - 10)}px`;
                        card.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
                    }, 50);

                    setTimeout(() => card.remove(), 500);
                }, i * 150); 
            }
        }

        function renderHand() {
            const area = document.getElementById('myHandArea');
            area.innerHTML = '';
            if (!myData.hand) return;

            myData.hand.forEach((card, index) => {
                const isSel = selectedCards.includes(index) ? 'selected' : '';
                area.innerHTML += `<img src="${CARD_IMAGES[card]}" class="real-card ${isSel}" style="z-index: ${index};" onclick="toggleCard(${index})">`;
            });
        }

        window.toggleCard = function(index) {
            if (gameState.turnId !== myId || gameState.status !== 'playing') return;
            if (selectedCards.includes(index)) selectedCards = selectedCards.filter(i => i !== index);
            else selectedCards.push(index);
            renderHand(); updateUI();
        };

        window.playCards = function() {
            if (selectedCards.length === 0) return;
            const cardsToPlay = selectedCards.map(i => myData.hand[i]);
            const newHand = myData.hand.filter((_, i) => !selectedCards.includes(i));
            push(actionsRef, { type: 'play', playerId: myId, cards: cardsToPlay });
            set(ref(db, `liars_rooms/${pin}/players/${myId}/hand`), newHand);
            selectedCards = [];
        };

        window.callLiar = function() {
            if (confirm("Ø§ØªÙ‡Ø§Ù… Ø®Ø·ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) push(actionsRef, { type: 'call_liar', playerId: myId });
        };

        window.shoot = function() {
            document.getElementById('shootBtn').style.display = 'none'; 
            push(actionsRef, { type: 'shoot', playerId: myId });
        };

        function updateUI() {
            const turnBanner = document.getElementById('turnBanner');
            const playBtn = document.getElementById('playBtn');
            const liarBtn = document.getElementById('liarBtn');
            const overlay = document.getElementById('overlayScreen');
            const overlayText = document.getElementById('overlayText');
            const shootBtn = document.getElementById('shootBtn');
            const tableMini = document.getElementById('tableMini');

            if (!myData.isAlive) {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h1 style='color:#ef4444; font-size:4rem;'>ğŸ’€</h1><h2>Ù„Ù‚Ø¯ Ù…Øª!</h2><p>Ø±Ø§Ù‚Ø¨ Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ù‡ÙˆØ³Øª...</p>";
                shootBtn.style.display = 'none'; return;
            }

            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex'; overlayText.innerHTML = "<h2>ğŸ» Ø­Ø§Ù†Ø© Ø§Ù„ÙƒØ°Ø§Ø¨ÙŠÙ†</h2><p>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù‡ÙˆØ³Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>"; shootBtn.style.display = 'none';
            } 
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                
                const stackCount = (gameState.tableStack || []).length;
                tableMini.innerHTML = `
                    <img src="${CARD_IMAGES[gameState.targetCard]}" class="target-card-img">
                    <div style="color: #fcd34d; font-weight: bold; margin-top:5px; font-size:0.9rem;">Ø§Ù„ÙˆØ±Ù‚: ${stackCount}</div>
                `;

                if (gameState.turnId === myId) {
                    turnBanner.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ÙŠØ§ <span>${myName}</span>!`;
                    turnBanner.style.borderBottomColor = '#10b981';
                    playBtn.disabled = selectedCards.length === 0;
                    liarBtn.disabled = stackCount === 0; 
                } else {
                    const actName = allPlayers[gameState.turnId] ? allPlayers[gameState.turnId].name : '...';
                    turnBanner.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span>${actName}</span>`;
                    turnBanner.style.borderBottomColor = '#333';
                    playBtn.disabled = true; liarBtn.disabled = true;
                }
            }
            else if (gameState.status === 'reveal' || gameState.status === 'roulette') {
                // Ø£Ø«Ù†Ø§Ø¡ Ù‚Ù„Ø¨ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„Ø±ÙˆÙ„ÙŠØªØŒ Ù†Ø¬Ø¨Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø± Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù‡ÙˆØ³Øª Ù„Ù„ØªØ´ÙˆÙŠÙ‚
                overlay.style.display = 'flex';
                if (gameState.victimId === myId && gameState.status === 'roulette') {
                    overlayText.innerHTML = "<h1 style='color:#ef4444;'>ğŸš¨ Ø£Ù†Øª Ø§Ù„Ø¶Ø­ÙŠØ©!</h1><p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</p>";
                    shootBtn.style.display = 'block';
                } else {
                    overlayText.innerHTML = `<h2>ğŸ‘€ Ø§Ù†Ø¸Ø± Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù‡ÙˆØ³Øª!</h2><p>ÙŠØªÙ… ÙƒØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù†...</p>`;
                    shootBtn.style.display = 'none';
                }
            }
        }
    </script>
</head>
<body>

    <div class="turn-banner" id="turnBanner">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <div class="arena-container" id="arenaContainer">
        <div class="table-mini" id="tableMini"></div>
        <div id="playersRing"></div>
    </div>

    <div class="my-hand-area" id="myHandArea"></div>

    <div class="controls">
        <button class="btn btn-play" id="playBtn" disabled onclick="playCards()">â¬‡ï¸ Ø§Ù†Ø²Ù„ Ø§Ù„ÙˆØ±Ù‚</button>
        <button class="btn btn-liar" id="liarBtn" disabled onclick="callLiar()">ğŸ¤¥ ÙƒØ§Ø§Ø§Ø°Ø¨!</button>
    </div>

    <div class="overlay-screen" id="overlayScreen">
        <div id="overlayText"></div>
        <button class="btn-shoot" id="shootBtn" onclick="shoot()">ğŸ”« Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</button>
    </div>

</body>
</html>
