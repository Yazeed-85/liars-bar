<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: #110808; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; touch-action: manipulation; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .turn-banner { width: 100%; background: #000; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid #333; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.8);}
        .turn-banner span { color: #f59e0b; font-size: 1.4rem; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†) */
        .top-table-area { flex: 1; background: radial-gradient(circle at top, #064e3b 0%, #022c22 100%); display: flex; flex-direction: column; align-items: center; padding: 15px; position: relative; border-bottom: 5px solid #451a03; box-shadow: inset 0 0 50px rgba(0,0,0,0.8);}
        
        /* Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ */
        .target-wrapper { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; margin-top: 10px;}
        .target-title { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 10px; border: 1px solid #333;}
        .target-card-img { width: 85px; border-radius: 6px; box-shadow: 0 0 20px rgba(252, 211, 77, 0.6); animation: pulse 2s infinite; border: 2px solid #fcd34d;}
        @keyframes pulse { 0% { box-shadow: 0 0 15px rgba(252, 211, 77, 0.4); } 50% { box-shadow: 0 0 35px rgba(252, 211, 77, 0.9); } 100% { box-shadow: 0 0 15px rgba(252, 211, 77, 0.4); } }

        /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®ØµÙˆÙ… Ø­ÙˆÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© */
        .opponents-ring { display: flex; justify-content: center; gap: 10px; width: 100%; flex-wrap: wrap; margin-bottom: auto;}
        .opp-badge { background: #1a0a0a; padding: 10px; border-radius: 10px; border: 1px solid #444; text-align: center; min-width: 80px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .opp-badge.active-opp { border-color: #f59e0b; background: #381a03; transform: scale(1.05);}
        .opp-badge.dead-opp { opacity: 0.3; text-decoration: line-through; border-color: #dc2626;}
        .opp-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;}
        .opp-gun { font-size: 0.8rem; color: #aaa; }
        .opp-order { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #f59e0b; color: #000; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; display: none;}
        .opp-badge.active-opp .opp-order { display: block; }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© */
        .table-center-info { font-size: 1.2rem; color: #fcd34d; font-weight: bold; background: rgba(0,0,0,0.7); padding: 8px 20px; border-radius: 20px; margin-bottom: 10px; border: 1px solid #555;}

        /* Ù…Ù†Ø·Ù‚Ø© ÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø§Ù„Ø£ÙˆØ±Ø§Ù‚) */
        .my-hand-area { background: #110808; padding: 20px 10px; display: flex; justify-content: center; height: 160px; align-items: flex-end;}
        
        /* Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª) */
        .real-card { width: 75px; border-radius: 5px; box-shadow: -5px 0 15px rgba(0,0,0,0.8); cursor: pointer; transition: all 0.2s ease-out; margin-left: -35px; position: relative;}
        .real-card:first-child { margin-left: 0; } /* Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø¯ÙˆÙ† Ù‡Ø§Ù…Ø´ Ø³Ù„Ø¨ÙŠ */
        .real-card:hover { transform: translateY(-10px); }
        .real-card.selected { transform: translateY(-25px); outline: 3px solid #f59e0b; z-index: 50; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.6);}

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .controls { display: flex; gap: 10px; padding: 15px; background: #000; border-top: 1px solid #333; z-index: 10;}
        .btn { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; color: white; transition: 0.1s;}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: #2563eb; }
        .btn-liar { background: #dc2626; }
        
        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ (Ø§Ù„Ù…ÙˆØªØŒ Ø§Ù„Ø±ÙˆÙ„ÙŠØª) */
        .overlay-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;}
        .btn-shoot { background: transparent; border: 3px solid #dc2626; color: #dc2626; padding: 20px 40px; font-size: 2rem; border-radius: 15px; margin-top: 30px; font-weight: bold; cursor: pointer;}
        .btn-shoot:active { background: #dc2626; color: white; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Ø´Ø© ---
        const storageKey = `liars_bar_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        
        if (!myId) {
            myId = "player_" + Date.now();
            localStorage.setItem(storageKey, myId);
            // ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            set(ref(db, `liars_rooms/${pin}/players/${myId}`), { name: myName, isAlive: true, hand: [] });
        } else {
            // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ùˆ Ø¹Ø§Ø¯
            get(ref(db, `liars_rooms/${pin}/players/${myId}/name`)).then((snap) => {
                if(snap.exists()) myName = snap.val();
            });
        }
        // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© onDisconnect Ù„ÙƒÙŠ Ù„Ø§ ÙŠÙ…ÙˆØª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ø°Ø§ Ø§Ù†Ø·ÙØ£Øª Ø´Ø§Ø´ØªÙ‡!

        const myRef = ref(db, `liars_rooms/${pin}/players/${myId}`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`);

        const CARD_IMAGES = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png',
            'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png'
        };

        let gameState = {};
        let allPlayers = {};
        let myData = {};
        let selectedCards = [];

        onValue(playersRef, (snap) => {
            if(snap.exists()) {
                allPlayers = snap.val();
                myData = allPlayers[myId] || {};
                renderTable();
                renderHand();
                updateUI();
            }
        });

        onValue(stateRef, (snap) => {
            if(snap.exists()) {
                gameState = snap.val();
                renderTable();
                updateUI();
            }
        });

        // ØªØ±ØªÙŠØ¨ ÙˆØ±Ø³Ù… Ø§Ù„Ø®ØµÙˆÙ… Ø­ÙˆÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
        function renderTable() {
            const ring = document.getElementById('opponentsRing');
            ring.innerHTML = '';
            
            const playerKeys = Object.keys(allPlayers);
            if (playerKeys.length === 0) return;

            // ØªØ­Ø¯ÙŠØ¯ ØªØ±ØªÙŠØ¨ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            let myIndex = playerKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø¨Ø¹Ø¯ÙŠØŒ ÙˆØªØ¯ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„ÙŠ
            const orderedOpponents = playerKeys.slice(myIndex + 1).concat(playerKeys.slice(0, myIndex));

            orderedOpponents.forEach(id => {
                const p = allPlayers[id];
                const isDead = p.isAlive === false ? 'dead-opp' : '';
                const isActive = gameState.turnId === id ? 'active-opp' : '';
                const chambers = p.currentChamber !== undefined ? p.currentChamber : 0;
                
                let tag = "";
                if(isActive) tag = "<div class='opp-order'>ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø¢Ù†</div>";

                ring.innerHTML += `
                    <div class="opp-badge ${isActive} ${isDead}">
                        ${tag}
                        <div class="opp-name">${p.name}</div>
                        <div class="opp-gun">ğŸ”« ${chambers}/6</div>
                    </div>
                `;
            });
        }

        // Ø±Ø³Ù… Ø£ÙˆØ±Ø§Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Ù…ØªØ¬Ø§ÙˆØ¨Ø© Flexbox)
        function renderHand() {
            const area = document.getElementById('myHandArea');
            area.innerHTML = '';
            if (!myData.hand) return;

            myData.hand.forEach((card, index) => {
                const isSel = selectedCards.includes(index) ? 'selected' : '';
                const imgSrc = CARD_IMAGES[card];
                
                area.innerHTML += `
                    <img src="${imgSrc}" 
                         id="card-${index}" 
                         class="real-card ${isSel}" 
                         style="z-index: ${index};"
                         onclick="toggleCard(${index})">
                `;
            });
        }

        window.toggleCard = function(index) {
            if (gameState.turnId !== myId || gameState.status !== 'playing') return;
            
            if (selectedCards.includes(index)) {
                selectedCards = selectedCards.filter(i => i !== index);
            } else {
                selectedCards.push(index);
            }
            renderHand(); 
            updateUI();
        };

        window.playCards = function() {
            if (selectedCards.length === 0) return;
            const cardsToPlay = selectedCards.map(i => myData.hand[i]);
            const newHand = myData.hand.filter((_, i) => !selectedCards.includes(i));
            
            push(actionsRef, { type: 'play', playerId: myId, cards: cardsToPlay });
            set(ref(db, `liars_rooms/${pin}/players/${myId}/hand`), newHand);
            selectedCards = [];
        };

        window.callLiar = function() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ§Ø¯Ù‚Ø§Ù‹ØŒ Ø³ØªØªÙ„Ù‚Ù‰ Ø£Ù†Øª Ø§Ù„Ø±ØµØ§ØµØ©!")) {
                push(actionsRef, { type: 'call_liar', playerId: myId });
            }
        };

        window.shoot = function() {
            document.getElementById('shootBtn').style.display = 'none'; 
            push(actionsRef, { type: 'shoot', playerId: myId });
        };

        function updateUI() {
            const turnBanner = document.getElementById('turnBanner');
            const targetContainer = document.getElementById('targetContainer');
            const tableCenterInfo = document.getElementById('tableCenterInfo');
            
            const playBtn = document.getElementById('playBtn');
            const liarBtn = document.getElementById('liarBtn');
            
            const overlay = document.getElementById('overlayScreen');
            const overlayText = document.getElementById('overlayText');
            const shootBtn = document.getElementById('shootBtn');

            if (!myData.isAlive) {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h1 style='color:#ef4444; font-size:4rem;'>ğŸ’€</h1><h2>Ù„Ù‚Ø¯ Ù…Øª!</h2><p style='color:#aaa; margin-top:10px;'>Ø±Ø§Ù‚Ø¨ Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ ÙˆÙ‡Ù… ÙŠØªØ³Ø§Ù‚Ø·ÙˆÙ†...</p>";
                shootBtn.style.display = 'none';
                return;
            }

            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = "<h2>ğŸ» Ø­Ø§Ù†Ø© Ø§Ù„ÙƒØ°Ø§Ø¨ÙŠÙ†</h2><p style='color:#aaa; margin-top:10px;'>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù‡ÙˆØ³Øª Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ±Ù‚...</p>";
                shootBtn.style.display = 'none';
            } 
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
                targetContainer.innerHTML = `
                    <div class="target-title">Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¹Ø¨:</div>
                    <img src="${CARD_IMAGES[gameState.targetCard]}" class="target-card-img">
                `;
                
                // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø©
                const stackCount = (gameState.tableStack || []).length;
                tableCenterInfo.innerText = `Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: ${stackCount}`;

                // ØªØ­Ø¯ÙŠØ¯ Ù…Ù† ÙŠÙ„Ø¹Ø¨
                if (gameState.turnId === myId) {
                    turnBanner.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ÙŠØ§ <span>${myName}</span>!`;
                    turnBanner.style.borderBottomColor = '#10b981';
                    
                    playBtn.disabled = selectedCards.length === 0;
                    liarBtn.disabled = stackCount === 0; 
                } else {
                    const activePlayerName = allPlayers[gameState.turnId] ? allPlayers[gameState.turnId].name : 'Ø´Ø®Øµ Ø¢Ø®Ø±';
                    turnBanner.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span>${activePlayerName}</span>`;
                    turnBanner.style.borderBottomColor = '#333';
                    
                    playBtn.disabled = true; 
                    liarBtn.disabled = true;
                }
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlayText.innerHTML = "<h1 style='color:#ef4444; font-size:3rem;'>ğŸš¨ Ø£Ù†Øª Ø§Ù„Ø¶Ø­ÙŠØ©!</h1><p style='font-size:1.2rem; margin-top:10px;'>Ø£Ù…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³ ÙˆØ§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯...</p>";
                    shootBtn.style.display = 'block';
                } else {
                    overlayText.innerHTML = `<h2>ğŸ˜± Ø±ÙˆÙ„ÙŠØª Ø§Ù„Ù…ÙˆØª</h2><p style='color:#aaa; margin-top:10px; font-size:1.2rem;'>${gameState.victimName} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³ ÙˆÙŠØ¯Ù‡ ØªØ±ØªØ¬Ù...</p>`;
                    shootBtn.style.display = 'none';
                }
            }
            else if (gameState.status === 'game_over') {
                overlay.style.display = 'flex';
                overlayText.innerHTML = `<h1 style='font-size:4rem;'>ğŸ†</h1><h2 style='color:#fcd34d;'>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2><p style='font-size:1.2rem; margin-top:10px;'>Ø§Ù„Ù†Ø§Ø¬ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± Ù‡Ùˆ: ${gameState.winnerName}</p>`;
                shootBtn.style.display = 'none';
            }
        }
    </script>
</head>
<body>

    <div class="turn-banner" id="turnBanner">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <div class="top-table-area">
        
        <div class="target-wrapper" id="targetContainer"></div>

        <div class="opponents-ring" id="opponentsRing"></div>
        
        <div class="table-center-info" id="tableCenterInfo">Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: 0</div>
    </div>

    <div class="my-hand-area" id="myHandArea"></div>

    <div class="controls">
        <button class="btn btn-play" id="playBtn" disabled onclick="playCards()">â¬‡ï¸ Ø§Ù†Ø²Ù„ Ø§Ù„ÙˆØ±Ù‚</button>
        <button class="btn btn-liar" id="liarBtn" disabled onclick="callLiar()">ğŸ¤¥ ÙƒØ§Ø§Ø§Ø°Ø¨!</button>
    </div>

    <div class="overlay-screen" id="overlayScreen">
        <div id="overlayText"></div>
        <button class="btn-shoot" id="shootBtn" onclick="shoot()">ğŸ”« Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯!</button>
    </div>

</body>
</html>
