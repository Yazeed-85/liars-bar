<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù„Ø¹Ø¨ - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #0a0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #1a0505 0%, #000 100%); touch-action: manipulation;}
        
        /* 1. Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„ÙŠØ§: Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© + Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .top-info-bar { padding: 10px; display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.6); border-bottom: 1px solid #333; height: 70px; z-index: 20;}
        .target-display { display: flex; align-items: center; gap: 10px; background: #3f1808; padding: 5px 15px; border-radius: 30px; border: 2px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);}
        .target-icon { width: 30px; height: 40px; background: white; border-radius: 4px; display: flex; justify-content: center; align-items: center; color: black; font-weight: bold; font-size: 1.2rem;}
        .room-pin { font-family: monospace; color: #666; font-size: 1.2rem; letter-spacing: 2px;}

        /* 2. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .table-area { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; perspective: 1000px;}
        
        /* Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ */
        .table-felt { width: 280px; height: 280px; background: radial-gradient(circle, #065f46 0%, #064e3b 100%); border-radius: 50%; border: 15px solid #451a03; box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 20px 60px rgba(0,0,0,0.8); position: relative; display: flex; justify-content: center; align-items: center;}
        
        /* ÙƒÙˆÙ…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø±Ù…ÙŠØ© (ÙˆØ§Ù‚Ø¹ÙŠØ©) */
        .discard-pile { position: relative; width: 60px; height: 90px;}
        .thrown-card { position: absolute; width: 60px; height: 84px; background-image: url('https://deckofcardsapi.com/static/img/back.png'); background-size: cover; border-radius: 5px; box-shadow: 1px 1px 4px rgba(0,0,0,0.5); border: 1px solid #ddd; top: 0; left: 0;}

        /* Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¯Ø§Ø¦Ø±ÙŠØ©) */
        .player-seat { position: absolute; width: 70px; height: 90px; display: flex; flex-direction: column; align-items: center; transition: all 0.5s; z-index: 10;}
        .avatar { width: 50px; height: 50px; background: #1f2937; border-radius: 50%; border: 2px solid #4b5563; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative;}
        .avatar img { width: 35px; }
        .p-name { background: rgba(0,0,0,0.8); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-top: -10px; z-index: 2; border: 1px solid #333; white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis;}
        .p-gun { font-size: 0.7rem; color: #f59e0b; font-weight: bold; background: #000; padding: 1px 5px; border-radius: 4px; margin-top: 2px;}
        
        .active-turn .avatar { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); transform: scale(1.1);}
        .is-me .avatar { border-color: #3b82f6; background: #172554;}
        .dead { opacity: 0.4; filter: grayscale(100%); }

        /* 3. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙŠØ¯ (Ø£ÙˆØ±Ø§Ù‚ÙŠ) */
        .my-hand { height: 160px; width: 100%; background: linear-gradient(to top, #1a0505, transparent); display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; gap: 0; z-index: 50; overflow-x: auto;}
        .hand-card { width: 80px; transition: transform 0.2s; margin-left: -35px; cursor: pointer; border-radius: 6px; box-shadow: -2px 0 10px rgba(0,0,0,0.5); position: relative;}
        .hand-card:first-child { margin-left: 0; }
        .hand-card.selected { transform: translateY(-30px); z-index: 100; outline: 3px solid #f59e0b; box-shadow: 0 10px 20px rgba(0,0,0,0.8);}
        .hand-card img { width: 100%; border-radius: 6px; display: block;}

        /* 4. Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .controls { position: absolute; bottom: 180px; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none; z-index: 60;}
        .btn { pointer-events: auto; padding: 12px 30px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 30px; cursor: pointer; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.1s; min-width: 120px;}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0; pointer-events: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø­Ø§Ø¬Ø© */
        .btn-play { background: linear-gradient(#2563eb, #1d4ed8); border: 2px solid #60a5fa; }
        .btn-liar { background: linear-gradient(#dc2626, #b91c1c); border: 2px solid #f87171; }
        
        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.92); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;}
        .start-btn { padding: 20px 50px; font-size: 1.5rem; background: #16a34a; color: white; border: none; border-radius: 15px; cursor: pointer; animation: pulse 2s infinite;}
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');
        const isHost = urlParams.get('role') === 'host';

        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‡ÙˆÙŠØ©
        const storageKey = `liars_v2_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) { myId = "p_" + Date.now(); localStorage.setItem(storageKey, myId); }

        // Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
        const rootRef = `liars_rooms/${pin}`;
        const myPlayerRef = ref(db, `${rootRef}/players/${myId}`);
        const playersRef = ref(db, `${rootRef}/players`);
        const stateRef = ref(db, `${rootRef}/gameState`);
        const actionsRef = ref(db, `${rootRef}/actions`);

        // Ø§Ù„ØµÙˆØ±
        const CARD_IMGS = {
            'K': 'https://deckofcardsapi.com/static/img/KH.png', 'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png', 'A': 'https://deckofcardsapi.com/static/img/AS.png',
            '10': 'https://deckofcardsapi.com/static/img/0S.png', 'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png'
        };

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        let gameState = { status: 'lobby', tableStack: [] };
        let players = {};
        let myHand = [];
        let selectedIndices = [];

        // 1. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        get(myPlayerRef).then((snap) => {
            if (!snap.exists()) {
                set(myPlayerRef, { 
                    name: myName, isAlive: true, hand: [], 
                    bulletIndex: Math.floor(Math.random() * 6), currentChamber: 0 
                });
            }
        });

        // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            myHand = players[myId]?.hand || [];
            renderTable();
            renderHand();
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || { status: 'lobby', tableStack: [] };
            renderUI();
            renderPile(); // ØªØ­Ø¯ÙŠØ« ÙƒÙˆÙ…Ø© Ø§Ù„ÙˆØ±Ù‚
        });

        // ----------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù‡ÙˆØ³Øª)
        // ----------------------------------------------------
        if (isHost) {
            // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
            update(stateRef, { status: 'lobby' }); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©

            // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©)
            window.hostStartGame = async function() {
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive);
                if (aliveIds.length < 2) return alert("Ù†Ø­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");

                // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ
                const N = aliveIds.length;
                let handSize = 6;
                let typesCount = 0;
                let jokersCount = 0;
                
                // Ù†Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø¹Ø§Ø¯Ù„Ø©: Total = 5*X + J Ø¨Ø­ÙŠØ« Total % N == 0
                // Ù†Ø¬Ø±Ø¨ Ø£Ø­Ø¬Ø§Ù… ÙŠØ¯ Ù…Ø®ØªÙ„ÙØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                const possibleSizes = [6, 5, 7, 8];
                let found = false;

                for (let size of possibleSizes) {
                    let totalNeeded = size * N;
                    // Ù†Ø¬Ø±Ø¨ 0 Ø£Ùˆ 1 Ø£Ùˆ 2 Ø¬ÙˆÙƒØ±
                    for (let j = 0; j <= 2; j++) {
                        if ((totalNeeded - j) % 5 === 0) {
                            typesCount = (totalNeeded - j) / 5;
                            jokersCount = j;
                            handSize = size;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }

                if (!found) {
                    // Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ù„Ø¬Ø£ Ù„ØªÙˆØ²ÙŠØ¹ ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙ Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Fallback)
                    handSize = 6; typesCount = Math.ceil((N*6)/5); jokersCount = 0;
                }

                // 2. Ø¨Ù†Ø§Ø¡ "Ø§Ù„Ø¯Ùƒ" (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©)
                let deck = [];
                ['K', 'Q', 'J', 'A', '10'].forEach(type => {
                    for(let i=0; i<typesCount; i++) deck.push(type);
                });
                for(let i=0; i<jokersCount; i++) deck.push('Joker');

                // Ø®Ù„Ø·
                deck.sort(() => Math.random() - 0.5);

                // 3. Ø§Ù„ØªÙˆØ²ÙŠØ¹
                let updates = {};
                aliveIds.forEach(id => {
                    let hand = deck.splice(0, handSize);
                    updates[`players/${id}/hand`] = hand;
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø³Ø¯Ø³ Ù„Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø£Ùˆ Ø¥Ø¨Ù‚Ø§Ø¤Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ)
                });

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯Ù (Ø¨Ø¯ÙˆÙ† Ø¬ÙˆÙƒØ±)
                const target = ['K', 'Q', 'J', 'A', '10'][Math.floor(Math.random() * 5)];
                const firstTurn = aliveIds[Math.floor(Math.random() * aliveIds.length)];

                updates[`gameState`] = {
                    status: 'playing',
                    targetCard: target,
                    turnId: firstTurn,
                    tableStack: [], // ØªØµÙÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
                    lastPlay: null
                };

                await update(ref(db, rootRef), updates);
            };

            // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Host Brain)
            onChildAdded(actionsRef, async (snap) => {
                const action = snap.val();
                const key = snap.key;
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive).sort(); // ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª

                if (action.type === 'play') {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ù„Ù„Ø·Ø§ÙˆÙ„Ø©
                    let stack = gameState.tableStack || [];
                    // Ù†Ø¶ÙŠÙ ÙÙ‚Ø· "Ø¸Ù‡ÙˆØ±" Ø§Ù„ÙˆØ±Ù‚Ø© ÙˆÙ„ÙŠØ³ Ù‚ÙŠÙ…ØªÙ‡Ø§ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù„Ù„ØªÙ…ÙˆÙŠÙ‡ ÙÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„)
                    // Ù„ÙƒÙ† ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø®Ø²Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙŠ lastPlay
                    const visualCards = action.cards.map(() => ({ rot: Math.random()*360, x: Math.random()*10, y: Math.random()*10 }));
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª
                    const newStack = stack.concat(visualCards);

                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ
                    const currIdx = aliveIds.indexOf(action.playerId);
                    const nextId = aliveIds[(currIdx + 1) % aliveIds.length];

                    await update(stateRef, {
                        tableStack: newStack,
                        turnId: nextId,
                        lastPlay: { playerId: action.playerId, cards: action.cards } // Ù‡Ù†Ø§ Ù†Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
                    });
                }
                else if (action.type === 'liar') {
                    // Ù…Ù†Ø·Ù‚ ÙƒØ´Ù Ø§Ù„ÙƒØ°Ø¨
                    const lastMove = gameState.lastPlay;
                    const accuser = players[action.playerId].name;
                    const accused = players[lastMove.playerId].name;
                    
                    let isLiar = false;
                    lastMove.cards.forEach(card => {
                        if (card !== gameState.targetCard && card !== 'Joker') isLiar = true;
                    });

                    let victimId = isLiar ? lastMove.playerId : action.playerId;
                    
                    await update(stateRef, {
                        status: 'reveal',
                        revealedCards: lastMove.cards,
                        isLiar: isLiar,
                        victimId: victimId,
                        msg: isLiar ? `ÙƒØ§Ø°Ø¨! ${accused} ØºØ´Ø§Ø´!` : `ØµØ§Ø¯Ù‚! ${accuser} Ø¸Ù„Ù…Ùƒ!`
                    });

                    setTimeout(() => update(stateRef, { status: 'roulette' }), 5000);
                }
                else if (action.type === 'shoot') {
                    const victim = players[action.playerId];
                    if (victim.currentChamber === victim.bulletIndex) {
                        // Ù…Ø§Øª
                        await update(ref(db, `${rootRef}/players/${action.playerId}`), { isAlive: false });
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§Ø¦Ø²
                        const survivors = aliveIds.filter(id => id !== action.playerId);
                        if (survivors.length === 1) {
                            await update(stateRef, { status: 'winner', winner: players[survivors[0]].name });
                        } else {
                            setTimeout(() => window.hostStartGame(), 3000); // Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        }
                    } else {
                        // Ù†Ø¬Ø§
                        await update(ref(db, `${rootRef}/players/${action.playerId}`), { currentChamber: victim.currentChamber + 1 });
                        setTimeout(() => window.hostStartGame(), 3000); // Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    }
                }

                remove(ref(db, `${rootRef}/actions/${key}`)); // Ø­Ø°Ù Ø§Ù„Ø£Ù…Ø±
            });
        }

        // ----------------------------------------------------
        // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø´ØªØ±ÙƒØ© Ù„Ù„Ø¬Ù…ÙŠØ¹)
        // ----------------------------------------------------
        
        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function renderTable() {
            const container = document.getElementById('playersRing');
            container.innerHTML = '';
            
            const pKeys = Object.keys(players).sort(); // ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ Ø«Ø§Ø¨Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø±Ø¤ÙŠØ©
            if (pKeys.length === 0) return;

            // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„ÙŠÙƒÙˆÙ† "Ø£Ù†Ø§" Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (index 0 Ø¨ØµØ±ÙŠØ§Ù‹)
            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0; // Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
            
            const count = pKeys.length;
            
            pKeys.forEach((id, i) => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø³Ø¨ÙŠ
                let relativeI = (i - myIndex + count) % count;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù„Ù‰ Ø¯Ø§Ø¦Ø±Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²ÙˆØ§ÙŠØ§)
                // Ø§Ù„Ù…ÙˆØ¶Ø¹ 0 (Ø£Ù†Ø§) ÙŠÙƒÙˆÙ† ÙÙŠ Ø²Ø§ÙˆÙŠØ© 90 Ø¯Ø±Ø¬Ø© (Ø£Ø³ÙÙ„)
                let angle = (relativeI / count) * (2 * Math.PI) + (Math.PI / 2);
                
                // Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)
                let rx = 140; // Ø¹Ø±Ø¶
                let ry = 140; // Ø·ÙˆÙ„
                
                let left = 50 + (Math.cos(angle) * 40); // %
                let top = 50 + (Math.sin(angle) * 40); // %

                const p = players[id];
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isDead = !p.isAlive ? 'dead' : '';
                const gunInfo = p.isAlive ? `ğŸ”« ${p.currentChamber}/6` : 'ğŸ’€';

                const el = document.createElement('div');
                el.className = `player-seat ${isActive} ${isDead} ${id === myId ? 'is-me' : ''}`;
                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.innerHTML = `
                    <div class="avatar">
                        <span style="font-size:20px">ğŸ‘¤</span>
                    </div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-gun">${gunInfo}</div>
                `;
                container.appendChild(el);
            });
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… ÙƒÙˆÙ…Ø© Ø§Ù„ÙˆØ±Ù‚ ÙÙŠ Ø§Ù„ÙˆØ³Ø·
        function renderPile() {
            const pile = document.getElementById('discardPile');
            const stack = gameState.tableStack || [];
            
            // Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø«Ù‚ÙŠÙ„ØŒ Ù†Ø¶ÙŠÙ ÙÙ‚Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ø²Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯
            // Ø£Ùˆ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù… Ø¥Ø°Ø§ ØµÙØ±Ù†Ø§ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
            if (stack.length === 0) {
                pile.innerHTML = '';
                return;
            }
            
            // Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø³ÙŠØ·Ø©: Ø¥Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ø®ØªÙ„Ù Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù… (Ø§Ù„Ø£Ø¨Ø³Ø· ÙˆØ§Ù„Ø£Ø¶Ù…Ù†)
            if (pile.childElementCount !== stack.length) {
                pile.innerHTML = '';
                stack.forEach((cardMeta, i) => {
                    const card = document.createElement('div');
                    card.className = 'thrown-card';
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø´ÙƒÙ„
                    card.style.transform = `rotate(${cardMeta.rot}deg) translate(${cardMeta.x}px, ${cardMeta.y}px)`;
                    card.style.zIndex = i;
                    pile.appendChild(card);
                });
            }
        }

        function renderHand() {
            const handDiv = document.getElementById('myHand');
            handDiv.innerHTML = '';
            if (!myHand) return;

            myHand.forEach((cardCode, i) => {
                const img = document.createElement('img');
                img.src = CARD_IMGS[cardCode] || CARD_IMGS['10']; // Fallback
                const div = document.createElement('div');
                div.className = `hand-card ${selectedIndices.includes(i) ? 'selected' : ''}`;
                div.onclick = () => toggleSelect(i);
                div.appendChild(img);
                handDiv.appendChild(div);
            });
        }

        window.toggleSelect = (i) => {
            if (gameState.status !== 'playing' || gameState.turnId !== myId) return;
            if (selectedIndices.includes(i)) selectedIndices = selectedIndices.filter(x => x !== i);
            else selectedIndices.push(i);
            renderHand();
            updateBtns();
        };

        function updateBtns() {
            const btnPlay = document.getElementById('btnPlay');
            const btnLiar = document.getElementById('btnLiar');
            
            if (gameState.turnId === myId) {
                // Ø²Ø± Ø§Ù„Ù„Ø¹Ø¨ Ù…ÙØ¹Ù„ Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª ÙˆØ±Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                btnPlay.disabled = selectedIndices.length === 0;
                // Ø²Ø± ÙƒØ§Ø°Ø¨ Ù…ÙØ¹Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙˆØ±Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
                btnLiar.disabled = (gameState.tableStack || []).length === 0;
                
                btnPlay.style.opacity = btnPlay.disabled ? 0.5 : 1;
                btnLiar.style.opacity = btnLiar.disabled ? 0.5 : 1;
                
                // Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ù…
                document.getElementById('controls').style.display = 'flex';
            } else {
                document.getElementById('controls').style.display = 'none';
            }
        }

        function renderUI() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
            document.getElementById('targetIcon').innerText = gameState.targetCard || '?';
            document.getElementById('pinDisplay').innerText = `PIN: ${pin}`;

            // Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
            const overlay = document.getElementById('overlay');
            
            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                if (isHost) {
                    overlay.innerHTML = `
                        <h2 style="color:#f59e0b">Ø£Ù†Øª Ø§Ù„Ù‡ÙˆØ³Øª ğŸ‘‘</h2>
                        <p>Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø«Ù… Ø§Ø¨Ø¯Ø£</p>
                        <button class="start-btn" onclick="triggerStart()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ²</button>
                    `;
                } else {
                    overlay.innerHTML = `<h2>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡ÙˆØ³Øª...</h2>`;
                }
            }
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none';
                updateBtns();
            }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                // Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©
                const cardsHTML = (gameState.revealedCards || []).map(c => 
                    `<img src="${CARD_IMGS[c]}" style="width:80px; margin:5px; border-radius:5px;">`
                ).join('');
                
                overlay.innerHTML = `
                    <h1 style="color:${gameState.isLiar ? '#ef4444' : '#22c55e'}">${gameState.msg}</h1>
                    <div style="margin:20px">${cardsHTML}</div>
                `;
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlay.innerHTML = `
                        <h1 style="color:red">ğŸ˜± Ø¯ÙˆØ±Ùƒ!</h1>
                        <p>Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø¬Ø§Ø© (Ø£Ùˆ Ø§Ù„Ù…ÙˆØª)</p>
                        <button class="start-btn" style="background:#dc2626" onclick="triggerShoot()">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯ ğŸ”«</button>
                    `;
                } else {
                    overlay.innerHTML = `<h2>ğŸ”« ${players[gameState.victimId].name} ÙŠØ·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±...</h2>`;
                }
            }
            else if (gameState.status === 'winner') {
                overlay.style.display = 'flex';
                overlay.innerHTML = `
                    <h1 style="color:gold; font-size:4rem">ğŸ†</h1>
                    <h1>Ø§Ù„ÙØ§Ø¦Ø²: ${gameState.winner}</h1>
                    ${isHost ? '<button class="start-btn" onclick="triggerStart()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>' : ''}
                `;
            }
        }

        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ±Ø³Ù„ ÙÙ‚Ø·)
        window.triggerStart = () => { if(isHost) window.hostStartGame(); };
        
        window.playAction = () => {
            const cards = selectedIndices.map(i => myHand[i]);
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
            push(actionsRef, { type: 'play', playerId: myId, cards: cards });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹ (Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø³Ù„Ø³)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§Ø­Ù‚Ø§Ù‹ØŒ Ù„ÙƒÙ† Ù†Ø­Ø°ÙÙ‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¶ØºØ·
            myHand = myHand.filter((_, i) => !selectedIndices.includes(i));
            selectedIndices = [];
            renderHand();
            document.getElementById('controls').style.display = 'none';
        };

        window.liarAction = () => {
            if(confirm("Ù…ØªØ£ÙƒØ¯ØŸ")) push(actionsRef, { type: 'liar', playerId: myId });
        };

        window.triggerShoot = () => {
            push(actionsRef, { type: 'shoot', playerId: myId });
            document.getElementById('overlay').innerHTML = `<h2>...</h2>`; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
        };

    </script>
</head>
<body>

    <div class="top-info-bar">
        <div class="room-pin" id="pinDisplay">PIN: ----</div>
        <div class="target-display">
            <span>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
            <div class="target-icon" id="targetIcon">?</div>
        </div>
    </div>

    <div class="table-area">
        <div id="playersRing" style="width:100%; height:100%; position:absolute;"></div>
        
        <div class="table-felt">
            <div class="discard-pile" id="discardPile">
                </div>
        </div>
    </div>

    <div id="controls" class="controls" style="display:none;">
        <button class="btn btn-play" id="btnPlay" onclick="playAction()">â¬‡ï¸ Ø§Ù†Ø²Ù„</button>
        <button class="btn btn-liar" id="btnLiar" onclick="liarAction()">ğŸ¤¥ ÙƒØ°Ø§Ø¨</button>
    </div>

    <div class="my-hand" id="myHand">
        </div>

    <div class="overlay" id="overlay">
        <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
    </div>

</body>
</html>
