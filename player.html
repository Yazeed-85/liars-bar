<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liar's Bar</title>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†Ø²ÙŠØ§Ø­ ÙˆØ§Ù„ØªØ´ÙˆÙ‡ */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #0a0505; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at center, #1a0505 0%, #000 100%); touch-action: manipulation;}
        
        /* --- 1. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø«Ø§Ø¨Øª Ø§Ù„Ø­Ø¬Ù… Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØµÙ…ÙŠÙ…) --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0,0,0,0.8); border-bottom: 2px solid #451a03; height: 80px; flex-shrink: 0; z-index: 20;}
        
        .room-pin { font-family: monospace; color: #888; font-size: 1.1rem; background: #111; padding: 5px 10px; border-radius: 8px;}
        
        .turn-indicator { flex: 1; text-align: center; font-size: 1.3rem; font-weight: bold;}
        .turn-indicator .highlight { color: #f59e0b; font-size: 1.6rem; text-shadow: 0 0 15px rgba(245, 158, 11, 0.8);}
        .turn-indicator.my-turn .highlight { color: #10b981; text-shadow: 0 0 15px rgba(16, 185, 129, 0.8);}

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø­Ø¬Ù… Ø«Ø§Ø¨Øª Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¶Ø®Ù…) */
        .target-box { display: flex; align-items: center; gap: 10px; background: #3f1808; padding: 5px 15px; border-radius: 12px; border: 1px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);}
        .target-box span { font-weight: bold; color: #fcd34d; font-size: 1rem;}
        .target-img-container { width: 35px; height: 50px; display: flex; justify-content: center; align-items: center; }
        .target-img-container img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; animation: glowTarget 1.5s infinite alternate;}
        @keyframes glowTarget { from { filter: drop-shadow(0 0 2px #f59e0b); } to { filter: drop-shadow(0 0 8px #f59e0b); transform: scale(1.05); } }

        /* --- 2. Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© --- */
        .arena { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;}
        
        .table { width: 70vmin; height: 70vmin; max-width: 450px; max-height: 450px; background: radial-gradient(circle, #065f46 0%, #022c22 100%); border-radius: 50%; border: 12px solid #451a03; box-shadow: inset 0 0 40px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.7); position: relative; display: flex; justify-content: center; align-items: center; z-index: 1;}
        
        /* Ø§Ù„ÙƒÙˆÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ (Ø¨Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©) */
        .discard-pile { position: absolute; width: 60px; height: 85px; top: 50%; left: 50%; transform: translate(-50%, -50%);}
        .thrown-card { position: absolute; width: 60px; height: 85px; background-image: url('https://deckofcardsapi.com/static/img/back.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 4px; box-shadow: 2px 2px 8px rgba(0,0,0,0.8); top: 0; left: 0; transform-origin: center;}

        /* Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-seat { position: absolute; width: 80px; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); z-index: 10;}
        .avatar-container { position: relative; width: 55px; height: 55px; display: flex; justify-content: center; align-items: center;}
        .avatar { width: 100%; height: 100%; background: #1f2937; border-radius: 50%; border: 3px solid #4b5563; display: flex; justify-content: center; align-items: center; font-size: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 2;}
        
        .p-name { background: rgba(0,0,0,0.9); padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; margin-top: -5px; z-index: 3; border: 1px solid #333; white-space: nowrap; max-width: 90px; overflow: hidden; text-overflow: ellipsis; font-weight: bold;}
        .p-gun { font-size: 0.75rem; color: #ef4444; background: #111; padding: 2px 6px; border-radius: 4px; margin-top: 3px; font-weight: bold; border: 1px solid #333;}
        
        /* Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø®Ø§Ø±Ù‚ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù†Ø´Ø· */
        .active-turn .avatar { border-color: #f59e0b; }
        .active-turn .avatar-container::before { content: ''; position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; border-radius: 50%; border: 4px solid #f59e0b; box-shadow: 0 0 20px #f59e0b, inset 0 0 20px #f59e0b; animation: superPulse 1s infinite alternate; z-index: 1;}
        @keyframes superPulse { 0% { transform: scale(0.9); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 1; } }
        .active-turn .p-name { color: #f59e0b; border-color: #f59e0b;}

        .is-me .avatar { border-color: #3b82f6; background: #1e3a8a;}
        .dead { opacity: 0.4; filter: grayscale(100%); }
        .dead .p-name { text-decoration: line-through; color: #666;}

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø±Ù…ÙŠ */
        .flying-card-anim { position: absolute; width: 60px; height: 85px; border-radius: 4px; z-index: 100; transition: all 0.4s ease-out; box-shadow: 0 15px 30px rgba(0,0,0,0.8);}

        /* --- 3. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ (Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚) --- */
        .bottom-area { background: #110808; border-top: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 20; flex-shrink: 0; position: relative;}
        
        .controls { display: flex; gap: 15px; margin-bottom: 10px; width: 90%; max-width: 500px;}
        .btn { flex: 1; padding: 12px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%);}
        .btn-play { background: linear-gradient(135deg, #2563eb, #1e3a8a); border-bottom: 4px solid #172554;}
        .btn-liar { background: linear-gradient(135deg, #dc2626, #7f1d1d); border-bottom: 4px solid #450a0a;}
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ */
        .my-hand { height: 110px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; width: 100%; overflow-x: auto;}
        .hand-card { min-width: 65px; max-width: 75px; aspect-ratio: 5/7; margin-left: -30px; cursor: pointer; transition: 0.2s; position: relative;}
        .hand-card:first-child { margin-left: 0; }
        .hand-card img { width: 100%; height: 100%; object-fit: contain; border-radius: 5px; box-shadow: -3px 0 10px rgba(0,0,0,0.8); display: block;}
        .hand-card.selected { transform: translateY(-20px); z-index: 50;}
        .hand-card.selected img { outline: 3px solid #f59e0b; box-shadow: 0 10px 20px rgba(245,158,11,0.8);}

        /* ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ù„Ù…ÙŠØª */
        .spectator-mode { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 60; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(2px);}
        .spectator-mode h2 { color: #ef4444; font-size: 2rem; margin: 0; text-shadow: 0 0 10px #000;}
        .spectator-mode p { color: #aaa; font-size: 1rem; margin-top: 5px;}

        /* --- 4. Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒØ¨ (Ø§Ù„Ù„ÙˆØ¨ÙŠØŒ Ø§Ù„ÙƒØ´ÙØŒ Ø§Ù„Ù†ØªÙŠØ¬Ø©) --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5,5,5,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(5px);}
        .start-btn { padding: 15px 40px; font-size: 1.6rem; background: linear-gradient(#16a34a, #15803d); color: white; border: none; border-radius: 12px; cursor: pointer; border-bottom: 5px solid #14532d; width: 100%; margin-top: 20px; transition: 0.2s;}
        .start-btn:active { transform: translateY(4px); border-bottom-width: 0px; }
        
        .reveal-cards { display: flex; gap: 10px; margin: 20px 0; justify-content: center;}
        .reveal-cards img { width: 80px; height: auto; border-radius: 6px; box-shadow: 0 0 15px rgba(255,255,255,0.2);}
        .truth-glow img { box-shadow: 0 0 40px #10b981; border: 3px solid #10b981;}
        .liar-glow img { box-shadow: 0 0 40px #dc2626; border: 3px solid #dc2626;}

        .result-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 2px solid #333; box-shadow: 0 20px 50px #000; max-width: 90%;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        let myName = urlParams.get('name');
        const isHost = urlParams.get('role') === 'host';

        const storageKey = `liars_v6_${pin}_myId`;
        let myId = localStorage.getItem(storageKey);
        if (!myId) { myId = "p_" + Date.now(); localStorage.setItem(storageKey, myId); }

        const rootRef = `liars_rooms/${pin}`;
        const myPlayerRef = ref(db, `${rootRef}/players/${myId}`);
        const playersRef = ref(db, `${rootRef}/players`);
        const stateRef = ref(db, `${rootRef}/gameState`);
        const actionsRef = ref(db, `${rootRef}/actions`);
        const eventsRef = ref(db, `${rootRef}/events`);

        // Ø§Ù„ØµÙˆØ± (4 Ø£Ù†ÙˆØ§Ø¹ ÙÙ‚Ø· ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª + Ø§Ù„Ø¬ÙˆÙƒØ±)
        const CARD_IMGS = {
            'K': 'https://deckofcardsapi.com/static/img/KH.png', 
            'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png', 
            'A': 'https://deckofcardsapi.com/static/img/AS.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };

        let gameState = { status: 'lobby', tableStack: [] };
        let players = {};
        let myHand = [];
        let selectedIndices = [];

        get(myPlayerRef).then((snap) => {
            if (!snap.exists()) {
                set(myPlayerRef, { name: myName, isAlive: true, hand: [], bulletIndex: Math.floor(Math.random() * 6), currentChamber: 0 });
            } else { if(snap.val().name) myName = snap.val().name; }
        });

        // ----------------------------------------------------
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø± Ù‡Ù†Ø§)
        // ----------------------------------------------------
        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            myHand = players[myId]?.hand || [];
            renderTable(); 
            renderHand();
            renderUI(); // ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† updateUI
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || { status: 'lobby', tableStack: [] };
            renderTable(); 
            renderUI(); 
            renderPile();
        });

        onChildAdded(eventsRef, (snap) => {
            const ev = snap.val();
            if (ev.type === 'throw' && (Date.now() - ev.time < 3000)) animateThrow(ev.playerId, ev.count);
        });

        // ----------------------------------------------------
        // Ø¹Ù‚Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± 
        // ----------------------------------------------------
        if (isHost) {
            window.hostStartGame = async function() {
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive);
                if (aliveIds.length < 2) return alert("Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±!");

                const numPlayers = aliveIds.length;
                let chosenSize = 6, jokersNeeded = 0, cardsPerType = 0, found = false;

                // Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ 4 Ø£Ù†ÙˆØ§Ø¹ Ø£Ø³Ø§Ø³ÙŠØ© (A, K, Q, J)
                for (let size of [5, 6, 7, 8]) {
                    let totalCards = size * numPlayers;
                    for (let j = 0; j <= 2; j++) {
                        if ((totalCards - j) % 4 === 0) {
                            chosenSize = size; jokersNeeded = j; cardsPerType = (totalCards - j) / 4; found = true; break;
                        }
                    }
                    if (found) break;
                }
                
                // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø­Ù…Ø§ÙŠØ© Ù„Ùˆ Ù„Ù… ÙŠØ¬Ø¯ Ù†ØªÙŠØ¬Ø© (Ù„Ù† ÙŠØ­Ø¯Ø«ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù„Ø­Ù…Ø§ÙŠØ©)
                if (!found) { chosenSize = 6; jokersNeeded = 0; cardsPerType = Math.ceil((6*numPlayers)/4); }

                let deck = [];
                ['A', 'K', 'Q', 'J'].forEach(type => { for(let k=0; k < cardsPerType; k++) deck.push(type); });
                for(let k=0; k < jokersNeeded; k++) deck.push('Joker');
                deck.sort(() => Math.random() - 0.5);

                let updates = {};
                aliveIds.forEach(id => { updates[`players/${id}/hand`] = deck.splice(0, chosenSize); });

                const target = ['A', 'K', 'Q', 'J'][Math.floor(Math.random() * 4)];
                const firstTurn = aliveIds[Math.floor(Math.random() * aliveIds.length)];

                updates[`gameState`] = { status: 'playing', targetCard: target, turnId: firstTurn, tableStack: [], lastPlay: null };
                await update(ref(db, rootRef), updates);
            };

            onChildAdded(actionsRef, async (snap) => {
                const action = snap.val();
                const key = snap.key;
                const aliveIds = Object.keys(players).filter(id => players[id].isAlive).sort(); 
                
                try {
                    if (action.type === 'play') {
                        let stack = gameState.tableStack || [];
                        const visualCards = action.cards.map(() => ({ rot: Math.random()*60 - 30, x: Math.random()*20 - 10, y: Math.random()*20 - 10 }));
                        
                        const evRef = push(eventsRef, { type: 'throw', playerId: action.playerId, count: action.cards.length, time: Date.now() });
                        setTimeout(() => remove(evRef), 4000);

                        const currIdx = aliveIds.indexOf(action.playerId);
                        const nextId = aliveIds[(currIdx + 1) % aliveIds.length];

                        await update(stateRef, { tableStack: stack.concat(visualCards), turnId: nextId, lastPlay: { playerId: action.playerId, cards: action.cards } });
                    }
                    else if (action.type === 'liar') {
                        const lastMove = gameState.lastPlay;
                        let isLiar = false;
                        lastMove.cards.forEach(card => { if (card !== gameState.targetCard && card !== 'Joker') isLiar = true; });

                        let victimId = isLiar ? lastMove.playerId : action.playerId;
                        
                        await update(stateRef, {
                            status: 'reveal', revealedCards: lastMove.cards, isLiar: isLiar, victimId: victimId,
                            msg: isLiar ? `ÙƒØ´ÙÙ†Ø§Ù‡! ${players[lastMove.playerId].name} ÙƒØ°Ø§Ø¨!` : `Ù…Ø³ÙƒÙŠÙ†! ${players[lastMove.playerId].name} ÙƒØ§Ù† ØµØ§Ø¯Ù‚!`
                        });

                        setTimeout(() => update(stateRef, { status: 'roulette' }), 5000);
                    }
                    else if (action.type === 'shoot') {
                        const victim = players[action.playerId];
                        const died = victim.currentChamber === victim.bulletIndex;
                        
                        await update(stateRef, { status: 'shot_result', died: died, victimName: victim.name });

                        if (died) {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { isAlive: false });
                            const survivors = aliveIds.filter(id => id !== action.playerId);
                            if (survivors.length === 1) {
                                setTimeout(() => update(stateRef, { status: 'winner', winner: players[survivors[0]].name }), 5000);
                            } else {
                                setTimeout(() => window.hostStartGame(), 5000);
                            }
                        } else {
                            await update(ref(db, `${rootRef}/players/${action.playerId}`), { currentChamber: victim.currentChamber + 1 });
                            setTimeout(() => window.hostStartGame(), 5000);
                        }
                    }
                } catch(e) { console.error(e); }
                remove(ref(db, `${rootRef}/actions/${key}`));
            });
        }

        // ----------------------------------------------------
        // Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙˆØªÙØ§Ø¹Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„
        // ----------------------------------------------------
        function renderTable() {
            const container = document.getElementById('playersRing');
            container.innerHTML = '';
            
            const pKeys = Object.keys(players).sort();
            if (pKeys.length === 0) return;

            let myIndex = pKeys.indexOf(myId);
            if (myIndex === -1) myIndex = 0;
            const count = pKeys.length;
            
            pKeys.forEach((id, i) => {
                let relativeI = (i - myIndex + count) % count;
                // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù„Ø¹Ø¨ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø¹ÙƒØ³ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©)
                let angle = (Math.PI / 2) - (relativeI / count) * (2 * Math.PI);
                
                let rx = 45; let ry = 42;
                let left = 50 + (Math.cos(angle) * rx); 
                let top = 50 + (Math.sin(angle) * ry); 

                const p = players[id];
                const isActive = gameState.turnId === id ? 'active-turn' : '';
                const isDead = !p.isAlive ? 'dead' : '';
                const isMe = id === myId ? 'is-me' : '';
                const gunInfo = p.isAlive ? `ğŸ”« ${p.currentChamber}/6` : 'ğŸ’€';

                const el = document.createElement('div');
                el.className = `player-seat ${isActive} ${isDead} ${isMe}`;
                el.id = `avatar-${id}`;
                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.innerHTML = `
                    <div class="avatar-container">
                        <div class="avatar"><span>ğŸ‘¤</span></div>
                    </div>
                    <div class="p-name">${id === myId ? '(Ø£Ù†Øª) '+p.name : p.name}</div>
                    <div class="p-gun">${gunInfo}</div>
                `;
                container.appendChild(el);
            });
        }

        window.animateThrow = function(playerId, count) {
            const avatar = document.getElementById(`avatar-${playerId}`);
            const tableCenter = document.getElementById('discardPile');
            if(!avatar || !tableCenter) return;

            const startRect = avatar.getBoundingClientRect();
            const endRect = tableCenter.getBoundingClientRect();

            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const card = document.createElement('div');
                    card.style.backgroundImage = `url('${CARD_IMGS['Back']}')`;
                    card.style.backgroundSize = 'contain';
                    card.style.backgroundRepeat = 'no-repeat';
                    card.className = 'flying-card-anim';
                    card.style.left = `${startRect.left + 10}px`;
                    card.style.top = `${startRect.top + 10}px`;
                    document.body.appendChild(card);

                    setTimeout(() => {
                        card.style.left = `${endRect.left + (Math.random()*10 - 5)}px`;
                        card.style.top = `${endRect.top + (Math.random()*10 - 5)}px`;
                        card.style.transform = `rotate(${Math.random() * 90 - 45}deg) scale(0.9)`;
                    }, 50);

                    setTimeout(() => card.remove(), 400);
                }, i * 150);
            }
        }

        function renderPile() {
            const pile = document.getElementById('discardPile');
            const stack = gameState.tableStack || [];
            
            if (pile.childElementCount !== stack.length) {
                pile.innerHTML = '';
                stack.forEach((meta, i) => {
                    const card = document.createElement('div');
                    card.className = 'thrown-card';
                    card.style.transform = `rotate(${meta.rot}deg) translate(${meta.x}px, ${meta.y}px)`;
                    card.style.zIndex = i;
                    pile.appendChild(card);
                });
            }
        }

        function renderHand() {
            const handDiv = document.getElementById('myHand');
            handDiv.innerHTML = '';
            if (!myHand || myHand.length === 0) return;

            myHand.forEach((cardCode, i) => {
                if(CARD_IMGS[cardCode]) { 
                    const img = document.createElement('img');
                    img.src = CARD_IMGS[cardCode]; 
                    const div = document.createElement('div');
                    div.className = `hand-card ${selectedIndices.includes(i) ? 'selected' : ''}`;
                    div.onclick = () => toggleSelect(i);
                    div.appendChild(img);
                    handDiv.appendChild(div);
                }
            });
        }

        window.toggleSelect = (i) => {
            if (gameState.status !== 'playing' || gameState.turnId !== myId || !players[myId].isAlive) return;
            if (selectedIndices.includes(i)) selectedIndices = selectedIndices.filter(x => x !== i);
            else selectedIndices.push(i);
            renderHand(); updateBtns();
        };

        window.playAction = () => {
            if (selectedIndices.length === 0) return;
            document.getElementById('btnPlay').disabled = true;

            const cards = selectedIndices.map(i => myHand[i]);
            myHand = myHand.filter((_, i) => !selectedIndices.includes(i));
            set(ref(db, `${rootRef}/players/${myId}/hand`), myHand); 
            
            push(actionsRef, { type: 'play', playerId: myId, cards: cards });
            selectedIndices = [];
            renderHand(); 
        };

        window.liarAction = () => {
            if(confirm("Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ§Ø¯Ù‚Ø§Ù‹ Ø³ØªÙ…ÙˆØª Ø£Ù†Øª! Ù…ØªØ£ÙƒØ¯ØŸ")) push(actionsRef, { type: 'liar', playerId: myId });
        };

        window.triggerShoot = () => {
            push(actionsRef, { type: 'shoot', playerId: myId });
            document.getElementById('overlay').innerHTML = `<h2>...</h2>`;
        };

        function updateBtns() {
            const btnPlay = document.getElementById('btnPlay');
            const btnLiar = document.getElementById('btnLiar');
            if (gameState.turnId === myId && players[myId]?.isAlive) {
                btnPlay.disabled = selectedIndices.length === 0;
                btnLiar.disabled = (gameState.tableStack || []).length === 0;
            } else {
                btnPlay.disabled = true; btnLiar.disabled = true;
            }
        }

        function renderUI() {
            if (gameState.targetCard) {
                document.getElementById('targetDisplay').innerHTML = `<img src="${CARD_IMGS[gameState.targetCard]}">`;
            }
            document.getElementById('pinDisplay').innerText = `PIN: ${pin}`;

            const turnInd = document.getElementById('turnIndicator');
            const spectatorMode = document.getElementById('spectatorMode');
            
            if (players[myId] && !players[myId].isAlive && gameState.status !== 'lobby') {
                spectatorMode.style.display = 'flex';
                turnInd.innerHTML = "ğŸ‘€ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©";
                turnInd.className = 'turn-indicator';
            } else {
                spectatorMode.style.display = 'none';
                if (gameState.status === 'playing') {
                    if (gameState.turnId === myId && players[myId]?.isAlive) {
                        turnInd.innerHTML = `Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ÙŠØ§ <span class="highlight">${myName}</span>!`;
                        turnInd.className = 'turn-indicator my-turn';
                    } else {
                        const tName = players[gameState.turnId] ? players[gameState.turnId].name : '...';
                        turnInd.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯: <span class="highlight">${tName}</span>`;
                        turnInd.className = 'turn-indicator';
                    }
                    updateBtns();
                }
            }

            const overlay = document.getElementById('overlay');
            if (gameState.status === 'lobby') {
                overlay.style.display = 'flex';
                if (isHost) {
                    overlay.innerHTML = `
                        <div class="result-box">
                            <h2 style="color:#aaa">Ø£Ø®Ø¨Ø± Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:</h2>
                            <div style="font-size: 5rem; font-weight: 900; color: #dc2626; letter-spacing: 5px; font-family: monospace;">${pin}</div>
                            <div style="color:#f59e0b; font-size:1.2rem; margin-bottom:20px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: ${Object.keys(players).length}</div>
                            <button class="start-btn" onclick="triggerStart()">ğŸ² Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                        </div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h2>Ø£Ù‡Ù„Ø§Ù‹ ${myName}</h2><p style="color:#aaa; margin-top:10px;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡ÙˆØ³Øª Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p></div>`;
                }
            }
            else if (gameState.status === 'playing') {
                overlay.style.display = 'none'; 
            }
            else if (gameState.status === 'reveal') {
                overlay.style.display = 'flex';
                const glow = gameState.isLiar ? 'liar-glow' : 'truth-glow';
                const cardsHTML = (gameState.revealedCards || []).map(c => `<div class="${glow} reveal-card-img"><img src="${CARD_IMGS[c]}" style="width:100%; display:block; border-radius:6px;"></div>`).join('');
                overlay.innerHTML = `
                    <div class="result-box">
                        <h1 style="color:${gameState.isLiar ? '#ef4444' : '#10b981'}; font-size:2rem; margin-bottom:20px;">${gameState.msg}</h1>
                        <div class="reveal-cards">${cardsHTML}</div>
                    </div>`;
            }
            else if (gameState.status === 'roulette') {
                overlay.style.display = 'flex';
                if (gameState.victimId === myId) {
                    overlay.innerHTML = `
                        <div class="result-box" style="border-color:#dc2626">
                            <h1 style="color:#ef4444; font-size:2.5rem">Ø¯ÙˆØ±Ùƒ ÙŠØ§ Ø¨Ø·Ù„!</h1>
                            <p style="margin:20px 0; color:#aaa;">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯ ÙˆØ§Ø¯Ø¹Ù Ø£Ù† ØªÙ†Ø¬Ùˆ...</p>
                            <button class="start-btn" style="background:#dc2626; border-bottom-color:#991b1b;" onclick="triggerShoot()">ğŸ”« Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø±</button>
                        </div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem">ğŸ”«</h1><h2>${players[gameState.victimId]?.name} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³...</h2></div>`;
                }
            }
            else if (gameState.status === 'shot_result') {
                overlay.style.display = 'flex';
                if (gameState.died) {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ’¥</h1><h1 style="color:#ef4444">Ø¨Ù€Ù€Ù€ÙˆÙˆÙˆÙ…!</h1><h2 style="margin-top:10px; color:#aaa;">Ù„Ù‚Ø¯ Ù…Ø§Øª ${gameState.victimName}!</h2></div>`;
                } else {
                    overlay.innerHTML = `<div class="result-box"><h1 style="font-size:4rem; color:#888">ÙƒÙ„ÙŠÙŠÙŠÙƒ...</h1><h2 style="color:#10b981; margin-top:10px;">Ù„Ù‚Ø¯ Ù†Ø¬Ø§ ${gameState.victimName}!</h2></div>`;
                }
            }
            else if (gameState.status === 'winner') {
                overlay.style.display = 'flex';
                overlay.innerHTML = `<div class="result-box"><h1 style="font-size:5rem">ğŸ†</h1><h2 style="margin-top:10px; color:#fcd34d">Ø§Ù„ÙØ§Ø¦Ø²: ${gameState.winner}</h2>${isHost ? '<button class="start-btn" style="margin-top:30px;" onclick="triggerStart()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>' : ''}</div>`;
            }
        }

        window.triggerStart = () => { if(isHost) window.hostStartGame(); };
    </script>
</head>
<body>

    <div class="top-bar">
        <div class="room-pin" id="pinDisplay">----</div>
        <div class="turn-indicator" id="turnIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div class="target-box">
            <span>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
            <div class="target-img-container" id="targetDisplay"></div>
        </div>
    </div>

    <div class="arena" id="gameArena">
        <div class="table">
            <div class="discard-pile" id="discardPile"></div>
        </div>
        <div id="playersRing" style="width:100%; height:100%; position:absolute;"></div>
    </div>

    <div class="bottom-area">
        <div class="spectator-mode" id="spectatorMode">
            <h2>ğŸ’€ Ø£Ù†Øª Ù…ÙŠØª</h2>
            <p>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
        </div>

        <div class="controls" id="controls">
            <button class="btn btn-play" id="btnPlay" disabled onclick="playAction()">â¬‡ï¸ Ø§Ù†Ø²Ù„</button>
            <button class="btn btn-liar" id="btnLiar" disabled onclick="liarAction()">ğŸ¤¥ ÙƒØ°Ø§Ø¨</button>
        </div>
        <div class="my-hand" id="myHand"></div>
    </div>

    <div class="overlay" id="overlay"></div>

</body>
</html>
