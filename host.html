<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liar's Bar - Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù‡ÙˆØ³Øª</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: #110808; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;}
        
        .header { text-align: center; margin-bottom: 20px; }
        .pin-display { font-size: 3rem; font-weight: bold; color: #dc2626; letter-spacing: 5px; background: rgba(0,0,0,0.5); padding: 10px 40px; border-radius: 10px; border: 2px dashed #dc2626; margin: 10px 0;}
        
        .panel { background: #1a0a0a; width: 100%; max-width: 900px; padding: 20px; border-radius: 15px; border: 2px solid #3a1a1a; margin-bottom: 20px;}
        h2 { color: #fca5a5; margin-bottom: 15px; border-bottom: 1px solid #3a1a1a; padding-bottom: 10px;}
        
        .players-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .player-badge { background: #000; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #333; width: 150px; position: relative;}
        .player-badge.active-turn { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);}
        .player-badge.dead { opacity: 0.3; text-decoration: line-through; border-color: #dc2626;}
        .gun-status { font-size: 0.9rem; color: #aaa; margin-top: 5px; background: #222; border-radius: 5px; padding: 3px;}

        .btn { background: #dc2626; color: white; border: none; padding: 15px 30px; font-size: 1.3rem; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.2s; width: 100%; max-width: 400px;}
        .btn:active { transform: scale(0.95); }

        /* Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© */
        .table-area { text-align: center; padding: 40px; background: #064e3b; border-radius: 200px; border: 15px solid #451a03; margin: 20px 0; width: 100%; max-width: 800px; box-shadow: inset 0 0 80px rgba(0,0,0,0.9), 0 15px 30px rgba(0,0,0,0.8); position: relative;}
        
        .real-card { width: 100px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.6); margin: 0 5px;}
        .target-section { margin-bottom: 20px; }
        
        .log-box { background: #000; padding: 15px; border-radius: 8px; color: #aaa; height: 180px; overflow-y: auto; text-align: right; font-family: monospace; border: 1px solid #333;}
        .log-important { color: #fca5a5; font-weight: bold;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y", authDomain: "buttons-f3501.firebaseapp.com", databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com", projectId: "buttons-f3501" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        document.getElementById('pinDisplay').innerText = pin;
        
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`);

        // ØµÙˆØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù…Ù† Ø³ÙŠØ±ÙØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©)
        const CARD_IMAGES = {
            'A': 'https://deckofcardsapi.com/static/img/AS.png',
            'K': 'https://deckofcardsapi.com/static/img/KH.png',
            'Q': 'https://deckofcardsapi.com/static/img/QD.png',
            'J': 'https://deckofcardsapi.com/static/img/JC.png',
            'Joker': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_joker.svg/200px-Card_joker.svg.png',
            'Back': 'https://deckofcardsapi.com/static/img/back.png'
        };
        const CARDS = ['A', 'K', 'Q', 'J', 'Joker'];

        let players = {};
        let gameState = { status: 'lobby' };

        set(stateRef, { status: 'lobby' });

        onValue(playersRef, (snap) => { players = snap.val() || {}; renderPlayers(); });
        onValue(stateRef, (snap) => { gameState = snap.val() || {}; updateHostUI(); });

        function logEvent(msg, isImportant = false) {
            const logBox = document.getElementById('logBox');
            logBox.innerHTML += `<div class="log-entry ${isImportant ? 'log-important' : ''}">> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        window.startGame = async function() {
            const pKeys = Object.keys(players);
            if(pKeys.length < 2) { alert("ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; }

            let updates = {};
            pKeys.forEach(id => {
                updates[`liars_rooms/${pin}/players/${id}/isAlive`] = true;
                updates[`liars_rooms/${pin}/players/${id}/bulletIndex`] = Math.floor(Math.random() * 6); // Ø±ØµØ§ØµØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† 0 Ø¥Ù„Ù‰ 5
                updates[`liars_rooms/${pin}/players/${id}/currentChamber`] = 0;
            });
            await update(ref(db), updates);
            startNewRound();
        };

        async function startNewRound() {
            const alivePlayers = Object.keys(players).filter(id => players[id].isAlive);
            if(alivePlayers.length === 1) {
                set(stateRef, { status: 'game_over', winnerName: players[alivePlayers[0]].name });
                logEvent(`ğŸ† ÙØ§Ø² ${players[alivePlayers[0]].name} Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©!`, true);
                return;
            }

            const targetCard = CARDS[Math.floor(Math.random() * 4)]; 
            const turnId = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];

            let updates = {};
            alivePlayers.forEach(id => {
                let hand = [];
                for(let i=0; i<6; i++) hand.push(CARDS[Math.floor(Math.random() * CARDS.length)]);
                updates[`liars_rooms/${pin}/players/${id}/hand`] = hand;
            });

            updates[`liars_rooms/${pin}/gameState`] = { status: 'playing', targetCard: targetCard, turnId: turnId, tableStack: [], lastPlay: null };
            await update(ref(db), updates);
            
            logEvent(`ğŸƒ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø§Ù„Ù„Ø¹Ø¨ Ø¹Ù„Ù‰: ${targetCard}`);
            logEvent(`ğŸ‘‰ Ø§Ù„Ø¯ÙˆØ± Ø¹Ù†Ø¯: ${players[turnId].name}`);
        }

        function getNextTurnId(currentId) {
            const alive = Object.keys(players).filter(id => players[id].isAlive);
            const idx = alive.indexOf(currentId);
            return alive[(idx + 1) % alive.length];
        }

        onChildAdded(actionsRef, async (snap) => {
            const action = snap.val();
            const actionKey = snap.key;
            
            if (action.type === 'play') {
                const pName = players[action.playerId].name;
                logEvent(`ğŸƒ ${pName} ÙˆØ¶Ø¹ ${action.cards.length} Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©.`);
                
                let newStack = gameState.tableStack || [];
                newStack.push(...action.cards);

                await update(stateRef, { tableStack: newStack, lastPlay: { playerId: action.playerId, cards: action.cards }, turnId: getNextTurnId(action.playerId) });
            } 
            else if (action.type === 'call_liar') {
                const challenger = players[action.playerId].name;
                const lastPlayerId = gameState.lastPlay.playerId;
                const lastPlayer = players[lastPlayerId].name;
                const playedCards = gameState.lastPlay.cards;
                
                logEvent(`ğŸš¨ ${challenger} ÙƒØ°Ù‘Ø¨ ${lastPlayer}!`, true);
                
                let isLiar = false;
                playedCards.forEach(c => { if(c !== gameState.targetCard && c !== 'Joker') isLiar = true; });

                let victimId = isLiar ? lastPlayerId : action.playerId;
                let victimName = isLiar ? lastPlayer : challenger;

                logEvent(isLiar ? `ğŸ’¥ ÙƒØ´Ù Ø§Ù„ÙƒØ°Ø¨Ø©! Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙƒØ§Ù†Øª (${playedCards.join(',')})! ${lastPlayer} Ø³ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø±ÙˆÙ„ÙŠØª!` : `âŒ Ø§ØªÙ‡Ø§Ù… Ø¨Ø§Ø·Ù„! Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ØµØ­ÙŠØ­Ø©! ${challenger} Ø³ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø±ÙˆÙ„ÙŠØª!`, true);

                await update(stateRef, { status: 'roulette', victimId: victimId, victimName: victimName, revealedCards: playedCards });
            }
            else if (action.type === 'shoot') {
                const vId = action.playerId;
                const vData = players[vId];
                
                logEvent(`ğŸ”« ${vData.name} ÙŠØ³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯...`);
                
                if (vData.currentChamber === vData.bulletIndex) {
                    logEvent(`ğŸ’€ Ø¨Ù€Ù€Ù€ÙˆÙˆÙˆÙ…! Ù…Ø§Øª ${vData.name}!`, true);
                    await update(ref(db, `liars_rooms/${pin}/players/${vId}`), { isAlive: false });
                } else {
                    logEvent(`ğŸ’¨ ÙƒÙ„ÙŠÙƒ! Ù†Ø¬Ø§ ${vData.name} Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.`);
                    await update(ref(db, `liars_rooms/${pin}/players/${vId}`), { currentChamber: vData.currentChamber + 1 });
                }
                setTimeout(() => { startNewRound(); }, 4000);
            }
            remove(ref(db, `liars_rooms/${pin}/actions/${actionKey}`));
        });

        function renderPlayers() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            Object.keys(players).forEach(id => {
                const p = players[id];
                const isTurn = gameState.turnId === id ? 'active-turn' : '';
                const isDead = p.isAlive === false ? 'dead' : '';
                const chambers = p.currentChamber !== undefined ? p.currentChamber : 0;
                
                list.innerHTML += `
                    <div class="player-badge ${isTurn} ${isDead}">
                        <div style="font-size: 1.2rem; margin-bottom:5px;">${p.name}</div>
                        <div class="gun-status">ğŸ”« Ø·Ù„Ù‚Ø§Øª: ${chambers} / 6</div>
                    </div>`;
            });
        }

        function updateHostUI() {
            renderPlayers();
            const tableArea = document.getElementById('tableArea');
            const startBtn = document.getElementById('startBtn');

            if (gameState.status === 'lobby') {
                tableArea.style.display = 'none';
                startBtn.style.display = 'block';
            } 
            else if (gameState.status === 'playing') {
                startBtn.style.display = 'none';
                tableArea.style.display = 'block';
                
                document.getElementById('tableContent').innerHTML = `
                    <div class="target-section">
                        <div style="color: #ccc; margin-bottom: 10px;">Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø§Ù„Ø¢Ù†:</div>
                        <img src="${CARD_IMAGES[gameState.targetCard]}" class="real-card">
                    </div>
                    <div style="color: #fcd34d; font-size: 1.2rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø©: ${(gameState.tableStack || []).length}</div>
                    <img src="${CARD_IMAGES['Back']}" class="real-card" style="transform: rotate(15deg); margin-top:10px;">
                `;
            }
            else if (gameState.status === 'roulette') {
                let revealedHTML = gameState.revealedCards ? gameState.revealedCards.map(c => `<img src="${CARD_IMAGES[c]}" class="real-card">`).join('') : '';
                document.getElementById('tableContent').innerHTML = `
                    <div style="color: #fca5a5; font-size: 1.5rem; margin-bottom: 10px;">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø®ÙÙŠØ© ÙƒØ§Ù†Øª:</div>
                    <div>${revealedHTML}</div>
                    <h2 style="color: #dc2626; margin-top:20px; font-size:2rem;">ğŸ”« ${gameState.victimName} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³...</h2>
                `;
            }
            else if (gameState.status === 'game_over') {
                document.getElementById('tableContent').innerHTML = `<h1 style="color:#f59e0b; font-size:3rem;">ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${gameState.winnerName}</h1>`;
                startBtn.style.display = 'block'; startBtn.innerText = "Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©";
            }
        }
    </script>
</head>
<body>
    <div class="header">
        <div style="color: #aaa;">ÙƒÙˆØ¯ Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù†Ø©:</div>
        <div class="pin-display" id="pinDisplay">----</div>
    </div>

    <div class="panel">
        <h2>ğŸ‘¥ Ø§Ù„Ø¬Ø§Ù„Ø³ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</h2>
        <div class="players-list" id="playersList"></div>
    </div>

    <button id="startBtn" class="btn" onclick="startGame()">ğŸ² ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ±Ù‚ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>

    <div class="table-area" id="tableArea" style="display: none;">
        <div id="tableContent"></div>
    </div>

    <div class="panel">
        <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
        <div class="log-box" id="logBox"></div>
    </div>
</body>
</html>
