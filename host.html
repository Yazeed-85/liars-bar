<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù‡ÙˆØ³Øª - Liar's Bar</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: #1a1010; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;}
        
        .header { text-align: center; margin-bottom: 20px; }
        .pin-display { font-size: 3rem; font-weight: bold; color: #dc2626; letter-spacing: 5px; background: rgba(0,0,0,0.5); padding: 10px 40px; border-radius: 10px; border: 2px dashed #dc2626; margin: 10px 0;}
        
        .panel { background: #2a1515; width: 100%; max-width: 800px; padding: 20px; border-radius: 10px; border: 1px solid #5a2a2a; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);}
        h2 { color: #fca5a5; margin-bottom: 15px; border-bottom: 1px solid #5a2a2a; padding-bottom: 10px;}
        
        .players-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .player-badge { background: #110808; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; border: 2px solid #444; position: relative;}
        .player-badge.active-turn { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);}
        .player-badge.dead { opacity: 0.3; text-decoration: line-through; border-color: #dc2626;}

        .btn { background: #dc2626; color: white; border: none; padding: 15px 30px; font-size: 1.3rem; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.2s; width: 100%; max-width: 400px;}
        .btn:active { transform: scale(0.95); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© */
        .table-area { text-align: center; padding: 30px; background: #064e3b; border-radius: 150px; border: 10px solid #78350f; margin: 20px 0; box-shadow: inset 0 0 50px rgba(0,0,0,0.8);}
        .target-card { font-size: 4rem; font-weight: bold; color: #fff; background: #dc2626; display: inline-block; padding: 10px 30px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #fff;}
        .table-stack { font-size: 1.5rem; color: #fcd34d; margin-top: 10px;}
        
        .log-box { background: #000; padding: 15px; border-radius: 8px; color: #aaa; height: 150px; overflow-y: auto; text-align: right; font-family: monospace; border: 1px solid #333;}
        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #222; padding-bottom: 5px;}
        .log-important { color: #fca5a5; font-weight: bold;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        document.getElementById('pinDisplay').innerText = pin;
        
        const roomRef = ref(db, `liars_rooms/${pin}`);
        const playersRef = ref(db, `liars_rooms/${pin}/players`);
        const stateRef = ref(db, `liars_rooms/${pin}/gameState`);
        const actionsRef = ref(db, `liars_rooms/${pin}/actions`); // ØµÙ†Ø¯ÙˆÙ‚ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†

        let players = {};
        let gameState = { status: 'lobby' };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØºØ±ÙØ©
        set(stateRef, { status: 'lobby' });

        onValue(playersRef, (snap) => {
            players = snap.val() || {};
            renderPlayers();
        });

        onValue(stateRef, (snap) => {
            gameState = snap.val() || {};
            updateHostUI();
        });

        function logEvent(msg, isImportant = false) {
            const logBox = document.getElementById('logBox');
            logBox.innerHTML += `<div class="log-entry ${isImportant ? 'log-important' : ''}">> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„Ù„Ø³ÙŠØ±ÙØ± (Host Logic) --- //
        
        const CARDS = ['A', 'K', 'Q', 'J', 'Joker'];

        window.startGame = async function() {
            const pKeys = Object.keys(players);
            if(pKeys.length < 2) { alert("ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; }

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ø¹Ø¨Ø©
            let updates = {};
            pKeys.forEach(id => {
                updates[`liars_rooms/${pin}/players/${id}/isAlive`] = true;
                // Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø³Ø¯Ø³ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Ù…Ù† 0 Ø¥Ù„Ù‰ 5)
                updates[`liars_rooms/${pin}/players/${id}/bulletIndex`] = Math.floor(Math.random() * 6);
                updates[`liars_rooms/${pin}/players/${id}/currentChamber`] = 0;
            });
            await update(ref(db), updates);
            
            startNewRound();
        };

        async function startNewRound() {
            const alivePlayers = Object.keys(players).filter(id => players[id].isAlive);
            if(alivePlayers.length === 1) {
                set(stateRef, { status: 'game_over', winnerName: players[alivePlayers[0]].name });
                logEvent(`ğŸ† ÙØ§Ø² ${players[alivePlayers[0]].name} Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©!`, true);
                return;
            }

            const targetCard = CARDS[Math.floor(Math.random() * 4)]; // Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¬ÙˆÙƒØ± ÙƒÙ‡Ø¯Ù
            const turnId = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];

            let updates = {};
            // ØªÙˆØ²ÙŠØ¹ 6 Ø£ÙˆØ±Ø§Ù‚ Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ø­ÙŠ
            alivePlayers.forEach(id => {
                let hand = [];
                for(let i=0; i<6; i++) hand.push(CARDS[Math.floor(Math.random() * CARDS.length)]);
                updates[`liars_rooms/${pin}/players/${id}/hand`] = hand;
            });

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
            updates[`liars_rooms/${pin}/gameState`] = {
                status: 'playing',
                targetCard: targetCard,
                turnId: turnId,
                tableStack: [],
                lastPlay: null
            };

            await update(ref(db), updates);
            logEvent(`ğŸƒ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø§Ù„Ù„Ø¹Ø¨ Ø¹Ù„Ù‰: ${targetCard}`);
            logEvent(`ğŸ‘‰ Ø§Ù„Ø¯ÙˆØ± Ø¹Ù†Ø¯: ${players[turnId].name}`);
        }

        function getNextTurnId(currentId) {
            const alive = Object.keys(players).filter(id => players[id].isAlive);
            const idx = alive.indexOf(currentId);
            return alive[(idx + 1) % alive.length];
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆÙŠØ¹Ø§Ù„Ø¬Ù‡Ø§)
        onChildAdded(actionsRef, async (snap) => {
            const action = snap.val();
            const actionKey = snap.key;
            
            if (action.type === 'play') {
                const pName = players[action.playerId].name;
                logEvent(`ğŸƒ ${pName} Ù†Ø²Ù„ ${action.cards.length} Ø£ÙˆØ±Ø§Ù‚.`);
                
                let newStack = gameState.tableStack || [];
                newStack.push(...action.cards);

                await update(stateRef, {
                    tableStack: newStack,
                    lastPlay: { playerId: action.playerId, cards: action.cards },
                    turnId: getNextTurnId(action.playerId)
                });
            } 
            else if (action.type === 'call_liar') {
                const challenger = players[action.playerId].name;
                const lastPlayerId = gameState.lastPlay.playerId;
                const lastPlayer = players[lastPlayerId].name;
                const playedCards = gameState.lastPlay.cards;
                
                logEvent(`ğŸš¨ ${challenger} ÙŠÙ‚ÙˆÙ„ Ø£Ù† ${lastPlayer} ÙƒØ§Ø°Ø¨!`, true);
                logEvent(`ğŸ‘€ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ù„Ø¹ÙˆØ¨Ø© ÙƒØ§Ù†Øª: ${playedCards.join(' Ùˆ ')}`);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ù‡Ùˆ ÙƒØ§Ø°Ø¨ØŸ (Ø§Ù„ÙƒØ°Ø§Ø¨ Ù‡Ùˆ Ù…Ù† Ù„Ø¹Ø¨ ÙˆØ±Ù‚Ø© Ù„ÙŠØ³Øª Ø§Ù„Ù‡Ø¯Ù ÙˆÙ„ÙŠØ³Øª Ø¬ÙˆÙƒØ±)
                let isLiar = false;
                playedCards.forEach(c => {
                    if(c !== gameState.targetCard && c !== 'Joker') isLiar = true;
                });

                let victimId = isLiar ? lastPlayerId : action.playerId;
                let victimName = isLiar ? lastPlayer : challenger;

                logEvent(isLiar ? `ğŸ’¥ ÙƒØ´Ù Ø§Ù„ÙƒØ°Ø¨Ø©! ${lastPlayer} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±!` : `âŒ Ø§ØªÙ‡Ø§Ù… Ø¨Ø§Ø·Ù„! ${challenger} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±!`, true);

                await update(stateRef, {
                    status: 'roulette',
                    victimId: victimId,
                    victimName: victimName
                });
            }
            else if (action.type === 'shoot') {
                const vId = action.playerId;
                const vData = players[vId];
                
                logEvent(`ğŸ”« ${vData.name} ÙŠØ³Ø­Ø¨ Ø§Ù„Ø²Ù†Ø§Ø¯...`);
                
                if (vData.currentChamber === vData.bulletIndex) {
                    logEvent(`ğŸ’€ Ø¨Ù€Ù€Ù€ÙˆÙˆÙˆÙ…! Ù…Ø§Øª ${vData.name}!`, true);
                    await update(ref(db, `liars_rooms/${pin}/players/${vId}`), { isAlive: false });
                } else {
                    logEvent(`ğŸ’¨ ÙƒÙ„ÙŠÙƒ! Ù†Ø¬Ø§ ${vData.name} Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.`);
                    await update(ref(db, `liars_rooms/${pin}/players/${vId}`), { currentChamber: vData.currentChamber + 1 });
                }

                // Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù„Ù„ØªØ´ÙˆÙŠÙ‚
                setTimeout(() => { startNewRound(); }, 3000);
            }

            // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ°Ù‡
            remove(ref(db, `liars_rooms/${pin}/actions/${actionKey}`));
        });

        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© --- //
        function renderPlayers() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            Object.keys(players).forEach(id => {
                const p = players[id];
                const isTurn = gameState.turnId === id ? 'active-turn' : '';
                const isDead = p.isAlive === false ? 'dead' : '';
                list.innerHTML += `<div class="player-badge ${isTurn} ${isDead}">${p.name}</div>`;
            });
        }

        function updateHostUI() {
            renderPlayers();
            const tableArea = document.getElementById('tableArea');
            const startBtn = document.getElementById('startBtn');

            if (gameState.status === 'lobby') {
                tableArea.style.display = 'none';
                startBtn.style.display = 'block';
            } 
            else if (gameState.status === 'playing') {
                startBtn.style.display = 'none';
                tableArea.style.display = 'block';
                document.getElementById('targetCard').innerText = gameState.targetCard;
                document.getElementById('tableStack').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: ${(gameState.tableStack || []).length}`;
            }
            else if (gameState.status === 'roulette') {
                tableArea.style.display = 'block';
                document.getElementById('targetCard').innerText = "Ø±ÙˆÙ„ÙŠØª Ø±ÙˆØ³ÙŠ ğŸ”«";
                document.getElementById('tableStack').innerText = `Ø§Ù„Ø¶Ø­ÙŠØ©: ${gameState.victimName} ÙŠÙ…Ø³Ùƒ Ø§Ù„Ù…Ø³Ø¯Ø³...`;
            }
            else if (gameState.status === 'game_over') {
                tableArea.style.display = 'block';
                document.getElementById('targetCard').innerText = "ğŸ† ÙØ§Ø¦Ø²!";
                document.getElementById('tableStack').innerText = `Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${gameState.winnerName}`;
                startBtn.style.display = 'block';
                startBtn.innerText = "Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©";
            }
        }
    </script>
</head>
<body>
    <div class="header">
        <div style="color: #aaa;">ÙƒÙˆØ¯ Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù†Ø©:</div>
        <div class="pin-display" id="pinDisplay">----</div>
        <div style="color: #ef4444; font-size:0.9rem;">âš ï¸ Ù„Ø§ ØªØºÙ„Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ø¨Ø¯Ø§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨</div>
    </div>

    <div class="panel">
        <h2>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</h2>
        <div class="players-list" id="playersList"></div>
    </div>

    <button id="startBtn" class="btn" onclick="startGame()">ğŸ² ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ±Ù‚ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>

    <div class="table-area" id="tableArea" style="display: none;">
        <div style="color: #ccc; margin-bottom: 10px;">Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø©:</div>
        <div class="target-card" id="targetCard">K</div>
        <div class="table-stack" id="tableStack">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: 0</div>
    </div>

    <div class="panel">
        <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
        <div class="log-box" id="logBox">
            <div class="log-entry">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
        </div>
    </div>
</body>
</html>